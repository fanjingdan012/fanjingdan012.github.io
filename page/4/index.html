<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"fanjingdan012.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="FJD">
<meta property="og:url" content="https://fanjingdan012.github.io/page/4/index.html">
<meta property="og:site_name" content="FJD">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="FJD">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://fanjingdan012.github.io/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>FJD</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">FJD</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-计算机知识树">

    <a href="/CSKT/" rel="section"><i class="fa fa-sitemap fa-fw"></i>计算机知识树</a>

  </li>
        <li class="menu-item menu-item-会计学知识树">

    <a href="/AccountingKT/" rel="section"><i class="fa fa-sitemap fa-fw"></i>会计学知识树</a>

  </li>
        <li class="menu-item menu-item-数学知识树">

    <a href="/MathKT/" rel="section"><i class="fa fa-sitemap fa-fw"></i>数学知识树</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanjingdan012.github.io/2019/05/10/csapp-Concurrent/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="FJD">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FJD">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/10/csapp-Concurrent/" class="post-title-link" itemprop="url">csapp Concurrent</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-10 18:14:49" itemprop="dateCreated datePublished" datetime="2019-05-10T18:14:49+08:00">2019-05-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-19 17:52:32" itemprop="dateModified" datetime="2021-11-19T17:52:32+08:00">2021-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Computer-Science/" itemprop="url" rel="index"><span itemprop="name">Computer Science</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="基于进程"><a href="#基于进程" class="headerlink" title="基于进程"></a>基于进程</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Fork()</span><br><span class="line">Signal(SIGCHLD, sigchld_handler)</span><br></pre></td></tr></table></figure>
<p>共享信息比thread少，浪费资源</p>
<h1 id="基于IO-Multiplexing"><a href="#基于IO-Multiplexing" class="headerlink" title="基于IO Multiplexing"></a>基于IO Multiplexing</h1><p>就是使用select操作fdset</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">select</span><span class="params">(<span class="keyword">int</span> n, fd_set *fdset, <span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>fdset就是fd列表的bitmap,n是大小,有这些宏操作指令</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FD_ZERO(fd_set *fdset); <span class="comment">//统统清空</span></span><br><span class="line">FD_CLR(<span class="keyword">int</span> fd,fd_set *fdset); <span class="comment">//清掉一个fd</span></span><br><span class="line">FD_SET(<span class="keyword">int</span> fd,fd_set *fdset); <span class="comment">//开一个fd</span></span><br><span class="line">FD_ISSET(<span class="keyword">int</span> fd,fd_set *fdset);<span class="comment">//返回某个fd是开着的吗</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/3e/ics3/code/conc/select.c">select.c</a></p>
<h1 id="基于线程"><a href="#基于线程" class="headerlink" title="基于线程"></a>基于线程</h1><h1 id="API"><a href="#API" class="headerlink" title="API"></a>API</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_create</span><span class="params">(<span class="keyword">pthread_t</span> *tid, <span class="keyword">pthread_addr_t</span> *addr, func *f, <span class="keyword">void</span> *arg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">pthread_t</span> <span class="title">pthread_self</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_exit</span><span class="params">(<span class="keyword">void</span> *thread_return)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cancel</span><span class="params">(<span class="keyword">pthread_t</span> tid)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_join</span><span class="params">(<span class="keyword">pthread_t</span> tid, <span class="keyword">void</span> **thread_return)</span></span>;<span class="comment">//阻塞，等tid结束，然后release它的资源，成功的话返回0</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_detach</span><span class="params">(<span class="keyword">pthread_t</span> tid)</span></span>;<span class="comment">//分离tid，我不管tid了，它结束了就自己回收资源吧</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_once</span><span class="params">(<span class="keyword">pthread_once_t</span> *once_control, <span class="keyword">void</span> (*init_routine)(<span class="keyword">void</span>))</span></span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="线程同步"><a href="#线程同步" class="headerlink" title="线程同步"></a>线程同步</h1><p>共享变量count问题</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">其他指令H</span><br><span class="line">movl count, %eax</span><br><span class="line">leal l(%eax), %edx //count++</span><br><span class="line">movl %edx, count</span><br><span class="line">其他指令T</span><br></pre></td></tr></table></figure>
<h2 id="进度图"><a href="#进度图" class="headerlink" title="进度图"></a>进度图</h2><p><img src="https://fanjingdan012.github.io/2019/05/10/csapp-Concurrent/progress-graph.png" alt="progress-graph"></p>
<h2 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h2><p>然后就要锁定不安全区<br><img src="https://fanjingdan012.github.io/2019/05/10/csapp-Concurrent/semaphore-op.png" alt="semaphore-op"><br><img src="https://fanjingdan012.github.io/2019/05/10/csapp-Concurrent/semaphore.png" alt="semaphore"><br>就是看每个点只能往上和往右走，但是P操作可能会被block，V操作是自由的<br>红线就是被block的P操作。保护出来走不到的点就是禁止区。</p>
<h2 id="线程不安全的情况"><a href="#线程不安全的情况" class="headerlink" title="线程不安全的情况"></a>线程不安全的情况</h2><ol>
<li>共享变量</li>
<li>调用线程不安全的函数</li>
</ol>
<h2 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h2><p><img src="https://fanjingdan012.github.io/2019/05/10/csapp-Concurrent/deadlock.png" alt="deadlock"><br>书里说的重叠就是死锁，不是说禁止区重叠，而是block的红线相交了，交点左下角那个地方又不能往上，又不能往右，死锁。<br>感觉这个进度图不太实用，一般判断死锁也不会去画这个。。。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanjingdan012.github.io/2019/05/10/Travel-France-Italy-16-days/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="FJD">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FJD">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/10/Travel-France-Italy-16-days/" class="post-title-link" itemprop="url">旅行：法国+意大利 16 天</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-10 13:56:53" itemprop="dateCreated datePublished" datetime="2019-05-10T13:56:53+08:00">2019-05-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-19 17:52:32" itemprop="dateModified" datetime="2021-11-19T17:52:32+08:00">2021-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Travel/" itemprop="url" rel="index"><span itemprop="name">Travel</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>攻略向</p>
<h1 id="签证"><a href="#签证" class="headerlink" title="签证"></a>签证</h1><ul>
<li>前提：住在上海，夫妻俩自由行，不参团，第一次申根签证</li>
<li>选择了法签，因为朋友说法签比较慷慨，以后也好升级<ul>
<li>官方说法是要看住的酒店天数，哪国最多就哪国，如果一样多就要看先入境的，为了法签特意把意大利和法国弄成各住7晚，因为巴黎进，罗马出，所以可以法签。</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://france-visas.gouv.fr/zh/web/france-visas">法签官网</a><ul>
<li>要注册，填报信息，准备材料，预约时间到签证中心（法国大使馆授权给签证中心了）提交材料。<a target="_blank" rel="noopener" href="https://france-visas.gouv.fr/zh/web/france-visas/visa-application-guidelines">签证中心官方步骤</a></li>
</ul>
</li>
<li>费用：如果你可以工作日请假，可以省去220元人民币/人的贵宾服务费，可惜我俩不行，因为两个人必须同时请假，一起递交材料。签证费650+服务费+贵宾费大概900多一个人，签证材料还要加上保险，200多一个人。后来上网看了，感觉淘宝代办省不了多少事，代办费多出300多，自己能搞定的</li>
<li>最麻烦的材料是在职证明，上面要求的项目很多，建议上网搜携程的模板，照着抄，否则容易漏点。</li>
<li>照片要求根本没有那么严，正常照片都能过，当时真是多虑了。</li>
<li>银行流水一定要柜台上拉，当时弄了个电子版，打电话确认说还是要柜台。。。</li>
<li>行程单用了穷游行程助手直接一键导出，很好用<ul>
<li>递交材料的时候被要求跨境的交通要有订单，当场买了法国到意大利的机票。要早做准备啊。</li>
<li>周末贵宾那个厅是有打印机和电脑的，普通的没有。</li>
</ul>
</li>
</ul>
<h1 id="电话卡和上网"><a href="#电话卡和上网" class="headerlink" title="电话卡和上网"></a>电话卡和上网</h1><ul>
<li>一定要提前某宝订好电话卡！</li>
<li>我们的选择是到了当地买小米的全球上网服务，极其不稳定，GPS走着走着就不动了，而且经常瞬间移动，价格也不便宜。莫不是走的欧洲版铁通网络。。。</li>
</ul>
<h1 id="换欧元"><a href="#换欧元" class="headerlink" title="换欧元"></a>换欧元</h1><ul>
<li>一定要国内换好，招商银行换的，7.67的汇率换了1200欧元，2000欧元以下不用预约。</li>
<li>法国exchange小店里骇人听闻，买入卖出价格8.9和6.7，甚至6.3，简直不能再坑。</li>
<li>信用卡要准备好，我的是万事达单标的（没有银联标志，国内刷不了的）一般汇率7.80-7.99左右。据说多个银联标志会更贵</li>
<li>支付宝，微信基本还没普及，都是信用卡多（当时是2019年3月）</li>
</ul>
<h1 id="语言"><a href="#语言" class="headerlink" title="语言"></a>语言</h1><ul>
<li>英语基本可以搞定</li>
<li>法国：出发前学了一丢丢，暴力替换一些单词可以看懂一些，不一定准确，但是实用<ul>
<li>de du = of d’XXX是de XXX的缩写</li>
<li>le, la = the，一个是阴the，一个是阳the，l’XXX是le XXX的缩写 </li>
<li>发音：Paris读巴黎就已经记住了1345<ol>
<li>r变h(其实是小舌音)，</li>
<li>h不发音，</li>
<li>所有a按照中国拼音a发音</li>
<li>后面元音的话p-&gt;b t-&gt;d之类的</li>
<li>词尾的辅音字母不发音</li>
</ol>
</li>
<li>例子：<ul>
<li>Musée du Louvre=museum of 卢浮</li>
<li>la Tour Eiffel=the tower 埃菲尔</li>
<li>Le Jardin de Luxembourg=the garden of 卢森堡</li>
<li>Musee de l’Orangerie=museum of the 橘园</li>
<li>Chateau de Versailles=castle of 凡尔塞</li>
<li>Notre Dame du Paris=我们的Madam（夫人）？of 巴黎（巴黎圣母院）</li>
<li>Gare du Nord=火车站 of North</li>
</ul>
</li>
</ul>
</li>
<li>意大利<ul>
<li>属于拉丁语，也能找到好多英语的影子</li>
<li>h不发音here=ear</li>
<li>g在词尾都发音morning=墨宁哥</li>
<li>j读成y，其实怀疑应该是measure的s的那种发音，jason=伊阿宋</li>
</ul>
</li>
</ul>
<h1 id="景点"><a href="#景点" class="headerlink" title="景点"></a>景点</h1><ul>
<li>每个月第一个周日免费参观博物馆，一定要选又贵又快的博物馆</li>
<li>关注开门关门时间，周一，周二开不开等信息</li>
<li>巴黎博物馆通票</li>
<li>买罗马通票一定要注意你有没有足够的时间参观罗马，如果光是交通费和斗兽场是不足以覆盖48小时票价的，应该还有凭票打折的功能</li>
<li>威尼斯通票，29岁以下29欧，以上39欧</li>
<li>好多学生票和青年票打折</li>
<li>需要提前补习人家的朝代，历代君主（参观城堡，军事博物馆等用），希腊罗马神话（雕塑和油画会用到），圣经故事（油画和教堂）</li>
<li>讲解器一般要5-7欧，死贵，但是还是需要的。</li>
</ul>
<h1 id="机票"><a href="#机票" class="headerlink" title="机票"></a>机票</h1><ul>
<li>感觉天巡网什么的都不给力，还是国内同程，携程，去哪什么的比较便宜，买的俄罗斯航空，如果联航机票（就是一次订单买的）就不需要过境签</li>
<li>回程买了卡塔尔航空，卡塔尔是免签国</li>
</ul>
<h1 id="酒店"><a href="#酒店" class="headerlink" title="酒店"></a>酒店</h1><ul>
<li>都是booking上订的，以为是hotel，其实是民宿，还要提前告知时间，否则就可能撞门上。。。</li>
<li>会额外收取城市税，按照星级，越高级的越贵。但是感觉明明是民宿啊，强行三星级，醉了。还有一些莫名其妙的费用，比如清洁费（你不清洁开啥旅馆呢？），空调费（我都没用空调强行收空调费，我申诉了，回我说这个就算是水电费！！！哪有旅馆额外收水电费的？）反正感觉就是各种乱，还不如直接airbnb全民宿呢。</li>
</ul>
<h1 id="租车"><a href="#租车" class="headerlink" title="租车"></a>租车</h1><ul>
<li>被坑了400把保险起赔从15000人民币降成0，其实租租车上已经买了国内的保险了，自己没仔细看条款，哎。。。</li>
<li>导航最好google baidu一起开，否则总有一家要坑你</li>
<li>停车好多都是路边自主缴费，用信用卡，白线可能免费，蓝线一定收费</li>
<li>油费比国内的贵，而且巴黎市内比较堵，找加油站比较难，关门也比较早（8点），巴黎还车的话最好早点加满油。</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>后来去网上看了跟团游的费用，好多反映在</p>
<ol>
<li>车上的时间要一半以上，</li>
<li>吃的都是中餐，</li>
<li>好多著名景点的时间给的太少，比如卢浮宫，我们用了一天，而跟团只给2小时，罗马斗兽场才半小时</li>
<li>非著名景点有的不安排，比如威尼斯总督府</li>
<li>有很多景点得自费，而且比官方票价贵</li>
<li>大把时间用在购物上<br>总体费用比较：如果做好足够的攻略，应该是自由行并不会贵太多，但是体验是质的飞越。</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanjingdan012.github.io/2019/05/09/Net/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="FJD">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FJD">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/09/Net/" class="post-title-link" itemprop="url">Net</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-09 18:42:07" itemprop="dateCreated datePublished" datetime="2019-05-09T18:42:07+08:00">2019-05-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-19 17:52:32" itemprop="dateModified" datetime="2021-11-19T17:52:32+08:00">2021-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Computer-Science/" itemprop="url" rel="index"><span itemprop="name">Computer Science</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="https://fanjingdan012.github.io/2019/05/09/Net/net.jpg" alt="net"></p>
<h1 id="OSI七层模型"><a href="#OSI七层模型" class="headerlink" title="OSI七层模型"></a>OSI七层模型</h1><p><img src="https://fanjingdan012.github.io/2019/05/09/Net/layers.png" alt="layers"><br>数据：<br><img src="https://fanjingdan012.github.io/2019/05/09/Net/data.png" alt="data"></p>
<p>internet connection:</p>
<ol>
<li>点对点</li>
<li>全双工Full-duplex：双向同时可以传输信息</li>
<li>可靠：最终会按照顺序收到所有包</li>
</ol>
<h1 id="Network"><a href="#Network" class="headerlink" title="Network"></a>Network</h1><p>SAN(System Area Network):cluster级别<br>LAN(Local …):building, campus<br>WAN(Wide …):world<br>internet:一堆network以共享的router互联, Internet: internet的最著名实现</p>
<h1 id="Socket-API"><a href="#Socket-API" class="headerlink" title="Socket API"></a>Socket API</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getaddrinfo</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *host,              </span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">const</span> <span class="keyword">char</span> *service            <span class="comment">/* port or service name */</span></span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">const</span> struct addrinfo *hints,  <span class="comment">/* input parameters */</span></span></span></span><br><span class="line"><span class="params"><span class="function">                struct addrinfo **result)</span>      <span class="comment">/* 这个其实是返回值linked list&lt;addrinfo&gt; */</span></span></span><br><span class="line"><span class="function"><span class="comment">//然后server端就会轮询这个linked list，尝试连接socket，直到bind成功</span></span></span><br><span class="line"><span class="function"><span class="comment">//client端轮询这个linked list，尝试连接socket，直到connect成功</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">freeaddrinfo</span><span class="params">(struct addrinfo *result)</span>     </span></span><br><span class="line"><span class="function"><span class="comment">//free linked list</span></span></span><br><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">gai_strerror</span><span class="params">(<span class="keyword">int</span> errcode)</span>          </span></span><br><span class="line"><span class="function"><span class="comment">//return error message</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">socket</span><span class="params">(<span class="keyword">int</span> domain, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol)</span></span></span><br><span class="line"><span class="function"><span class="comment">//3个参数总是AF_INET SOCK_STREAM 0，就是创建socket</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bind</span><span class="params">(<span class="keyword">int</span> sockfd, SA *addr, <span class="keyword">socklen_t</span> addrlen)</span></span></span><br><span class="line"><span class="function"><span class="comment">//告诉kernal把addr和sockfd bind起来</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">listen</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">int</span> backlog)</span></span></span><br><span class="line"><span class="function"><span class="comment">//kernal 默认socket函数的fd都是active socket，这个函数是告诉kernal把这个sockfd变成server端的listening socket,阻塞的</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">accept</span><span class="params">(intlistenfd, SA *addr, <span class="keyword">int</span> *addrlen)</span></span></span><br><span class="line"><span class="function"> <span class="comment">//server 等待connect连上来，后两个参数其实是返回值，客户端的socket地址和地址长度,函数本身的返回值是connected fd</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">connect</span><span class="params">(<span class="keyword">int</span> clientfd, SA *addr, <span class="keyword">socklen_t</span> addrlen)</span></span></span><br><span class="line"><span class="function"><span class="comment">//也是阻塞的</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">open_listenfd</span><span class="params">(<span class="keyword">int</span> port)</span></span>=socket+bind+<span class="function">listen</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">open_clientfd</span><span class="params">()</span></span>=socket+connect</span><br></pre></td></tr></table></figure>
<p>socket<br>socket address= IP地址:port<br>![socket-api](<a target="_blank" rel="noopener" href="https://fanjingdanhttps//fanjingdan012.github.io/2019/05/09/Net/">https://fanjingdanhttps://fanjingdan012.github.io/2019/05/09/Net/</a></p>
<h1 id="Example-Code"><a href="#Example-Code" class="headerlink" title="Example Code"></a>Example Code</h1><p>一个小型server，main方法进来，无限循环accept(),然后doit()做一些读写和处理<br><a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/3e/ics3/code/netp/tiny/tiny.c">tiny.c</a></p>
<h1 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$&gt; nslookup localhost</span><br><span class="line">127.0.0.1</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanjingdan012.github.io/2019/05/07/csapp-IO/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="FJD">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FJD">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/07/csapp-IO/" class="post-title-link" itemprop="url">csapp IO</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-07 15:19:51" itemprop="dateCreated datePublished" datetime="2019-05-07T15:19:51+08:00">2019-05-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-19 17:52:32" itemprop="dateModified" datetime="2021-11-19T17:52:32+08:00">2021-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Computer-Science/" itemprop="url" rel="index"><span itemprop="name">Computer Science</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>标准输入STDIN_FILENO=0 标准输出STDOUT_FILENO=1 标准错误 STDERR_FILENO=2<br>文件位置k=0</p>
<h1 id="打开关闭"><a href="#打开关闭" class="headerlink" title="打开关闭"></a>打开关闭</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">open</span><span class="params">(<span class="keyword">char</span> *filename, <span class="keyword">int</span> flags, <span class="keyword">mode_t</span> mode)</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">close</span><span class="params">(<span class="keyword">int</span> fd)</span></span></span><br></pre></td></tr></table></figure>

<h1 id="读写"><a href="#读写" class="headerlink" title="读写"></a>读写</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">read</span> <span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> n)</span> <span class="comment">//从fd读取n个byte到buf里</span></span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">write</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> n)</span></span></span><br></pre></td></tr></table></figure>
<p>ssize_t是int而size_t是unsigned int</p>
<h1 id="Rio-Robust-io"><a href="#Rio-Robust-io" class="headerlink" title="Rio(Robust io)"></a>Rio(Robust io)</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">rio_readn</span> <span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span> *usrbuf, <span class="keyword">size_t</span> n)</span></span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">rio_writen</span> <span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span> *usrbuf, <span class="keyword">size_t</span> n)</span></span></span><br></pre></td></tr></table></figure>

<h1 id="读取文件元数据"><a href="#读取文件元数据" class="headerlink" title="读取文件元数据"></a>读取文件元数据</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">stat</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *filename , struct stat *buf)</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fstat</span><span class="params">(<span class="keyword">int</span> fd, struct stat *buf)</span></span></span><br></pre></td></tr></table></figure>
<h1 id="内核处理"><a href="#内核处理" class="headerlink" title="内核处理"></a>内核处理</h1><p><img src="https://fanjingdan012.github.io/2019/05/07/csapp-IO/io.png" alt="io"><br><img src="https://fanjingdan012.github.io/2019/05/07/csapp-IO/io-share.png" alt="io-share"><br><img src="https://fanjingdan012.github.io/2019/05/07/csapp-IO/io-subthread.png" alt="io-subthread"></p>
<h1 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dup2</span><span class="params">(<span class="keyword">int</span> oldfd, <span class="keyword">int</span> <span class="keyword">new</span> fd)</span></span></span><br></pre></td></tr></table></figure>
<p><img src="https://fanjingdan012.github.io/2019/05/07/csapp-IO/io-dup2.png" alt="io-dup2"></p>
<h1 id="所有函数"><a href="#所有函数" class="headerlink" title="所有函数"></a>所有函数</h1><p><img src="https://fanjingdan012.github.io/2019/05/07/csapp-IO/io-apis.png" alt="io-apis"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanjingdan012.github.io/2019/04/25/Dubbo-ProviderRegister/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="FJD">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FJD">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/25/Dubbo-ProviderRegister/" class="post-title-link" itemprop="url">Dubbo Provider Register</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-04-25 14:01:15" itemprop="dateCreated datePublished" datetime="2019-04-25T14:01:15+08:00">2019-04-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-19 17:52:32" itemprop="dateModified" datetime="2021-11-19T17:52:32+08:00">2021-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Computer-Science/" itemprop="url" rel="index"><span itemprop="name">Computer Science</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanjingdan012.github.io/2019/04/16/Spring-Transaction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="FJD">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FJD">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/16/Spring-Transaction/" class="post-title-link" itemprop="url">Spring Transaction</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-04-16 19:19:08" itemprop="dateCreated datePublished" datetime="2019-04-16T19:19:08+08:00">2019-04-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-19 17:52:32" itemprop="dateModified" datetime="2021-11-19T17:52:32+08:00">2021-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Computer-Science/" itemprop="url" rel="index"><span itemprop="name">Computer Science</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Propagation"><a href="#Propagation" class="headerlink" title="Propagation"></a>Propagation</h1><p><img src="https://fanjingdan012.github.io/2019/04/16/Spring-Transaction/propagation.png" alt="Propagation"></p>
<h1 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h1><p>其实通过Interceptor加的。<br><code>TransactionAspectSupport.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * General delegate for around-advice-based subclasses, delegating to several other template</span></span><br><span class="line"><span class="comment">	 * methods on this class. Able to handle &#123;<span class="doctag">@link</span> CallbackPreferringPlatformTransactionManager&#125;</span></span><br><span class="line"><span class="comment">	 * as well as regular &#123;<span class="doctag">@link</span> PlatformTransactionManager&#125; implementations.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> method the Method being invoked</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> targetClass the target class that we&#x27;re invoking the method on</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> invocation the callback to use for proceeding with the target invocation</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> Object <span class="title">invokeWithinTransaction</span><span class="params">(Method method, <span class="meta">@Nullable</span> Class&lt;?&gt; targetClass,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">final</span> InvocationCallback invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// If the transaction attribute is null, the method is non-transactional.</span></span><br><span class="line">		TransactionAttributeSource tas = getTransactionAttributeSource();</span><br><span class="line">		<span class="keyword">final</span> TransactionAttribute txAttr = (tas != <span class="keyword">null</span> ? tas.getTransactionAttribute(method, targetClass) : <span class="keyword">null</span>);</span><br><span class="line">		<span class="keyword">final</span> PlatformTransactionManager tm = determineTransactionManager(txAttr);</span><br><span class="line">		<span class="keyword">final</span> String joinpointIdentification = methodIdentification(method, targetClass, txAttr);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (txAttr == <span class="keyword">null</span> || !(tm <span class="keyword">instanceof</span> CallbackPreferringPlatformTransactionManager)) &#123;</span><br><span class="line">			<span class="comment">// Standard transaction demarcation with getTransaction and commit/rollback calls.</span></span><br><span class="line">			TransactionInfo txInfo = createTransactionIfNecessary(tm, txAttr, joinpointIdentification);</span><br><span class="line">			Object retVal = <span class="keyword">null</span>;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="comment">// This is an around advice: Invoke the next interceptor in the chain.</span></span><br><span class="line">				<span class="comment">// This will normally result in a target object being invoked.</span></span><br><span class="line">				retVal = invocation.proceedWithInvocation();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">				<span class="comment">// target invocation exception</span></span><br><span class="line">				completeTransactionAfterThrowing(txInfo, ex);</span><br><span class="line">				<span class="keyword">throw</span> ex;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">finally</span> &#123;</span><br><span class="line">				cleanupTransactionInfo(txInfo);</span><br><span class="line">			&#125;</span><br><span class="line">			commitTransactionAfterReturning(txInfo);</span><br><span class="line">			<span class="keyword">return</span> retVal;</span><br><span class="line">		&#125; <span class="keyword">else</span>&#123;...CallbackPreferringPlatformTransactionManager处理：可以定义transaction callback的&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>transactionInfoHolder 其实是个ThreadLocal bindToThread</p>
<h1 id="提交点"><a href="#提交点" class="headerlink" title="提交点"></a>提交点</h1><p>java1.4<br>savepoint<br>a1<br>insert1<br>a2<br>insert2<br>a3<br>insert3</p>
<p>savepoint是在数据库事务处理中实现“子事务”（subtransaction），也称为嵌套事务的方法。事务可以回滚到savepoint而不影响savepoint创建前的变化。不需要放弃整个事务。</p>
<p>SQL语言国际标准中，SAVEPOINT name语句声明一个savepoint。ROLLBACK TO SAVEPOINT name语句回滚到savepoint。RELEASE SAVEPOINT name将使得命名的savepoint被放弃，但不影响其他savepoint。ROLLBACK或COMMIT导致所有savepoint被放弃。</p>
<p>支持savepoint的数据库有：PostgreSQL, Oracle数据库, Microsoft SQL Server, MySQL, DB2, SQLite (从3.6.8), Firebird, H2数据库, Informix (从11.50xC3).</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanjingdan012.github.io/2019/04/10/Economic-History/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="FJD">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FJD">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/10/Economic-History/" class="post-title-link" itemprop="url">Econimic History</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-04-10 10:50:55" itemprop="dateCreated datePublished" datetime="2019-04-10T10:50:55+08:00">2019-04-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-19 17:52:32" itemprop="dateModified" datetime="2021-11-19T17:52:32+08:00">2021-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Computer-Science/" itemprop="url" rel="index"><span itemprop="name">Computer Science</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>米尔顿.弗里德曼 1912-<ul>
<li>自由经济</li>
</ul>
</li>
<li>科斯</li>
<li>张五常<ul>
<li>市场经济</li>
</ul>
</li>
<li>阿尔钦<ul>
<li>产权与竞争</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanjingdan012.github.io/2019/04/10/GC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="FJD">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FJD">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/10/GC/" class="post-title-link" itemprop="url">GC</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-04-10 10:50:55" itemprop="dateCreated datePublished" datetime="2019-04-10T10:50:55+08:00">2019-04-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-19 17:52:32" itemprop="dateModified" datetime="2021-11-19T17:52:32+08:00">2021-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Computer-Science/" itemprop="url" rel="index"><span itemprop="name">Computer Science</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="分代"><a href="#分代" class="headerlink" title="分代"></a>分代</h1><p><img src="https://fanjingdan012.github.io/2019/04/10/GC/Memory.png" alt="分代和JMM"><br>GC就发生在Heap和Metaspace</p>
<ul>
<li>XX:SurvivorRatio = Eden/S0(=S1) = 8(default)</li>
<li>XX:NewRatio = Old/Young = 2(default)</li>
</ul>
<h1 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h1><ul>
<li>并行（Parallel）：指多条垃圾收集线程并行工作，但此时用户线程仍然处于等待状态。</li>
<li>并发（Concurrent）：指用户线程与垃圾收集线程同时执行（但不一定是并行的，可能会交替执行），用户程序在继续运行，而垃圾收集程序运行于另一个CPU上。</li>
<li>吞吐量：就是CPU用于运行用户代码的时间与CPU总消耗时间的比值，即吞吐量 = 运行用户代码时间 /（运行用户代码时间 + 垃圾收集时间）。虚拟机总共运行了100分钟，其中垃圾收集花掉1分钟，那吞吐量就是99%。停顿时间越短就越适合需要与用户交互的程序，良好的响应速度能提升用户体验，而高吞吐量则可以高效率地利用CPU时间，尽快完成程序的运算任务，主要适合在后台运算而不需要太多交互的任务。</li>
<li>STW stop-the-world</li>
</ul>
<h1 id="java对象存活分析"><a href="#java对象存活分析" class="headerlink" title="java对象存活分析"></a>java对象存活分析</h1><h2 id="引用计数法"><a href="#引用计数法" class="headerlink" title="引用计数法"></a>引用计数法</h2><ul>
<li>在堆中存储对象时，在对象头处维护一个counter计数器，如果一个对象增加了一个引用与之相连，则将counter++。如果一个引用关系失效则counter–。如果一个对象的counter变为0，则说明该对象已经被废弃，不处于存活状态。</li>
<li>缺点<ul>
<li>jdk从1.2开始增加了多种引用方式：软引用、弱引用、虚引用，且在不同引用情况下程序应进行不同的操作。如果我们只采用一个引用计数法来计数无法准确的区分这么多种引用的情况。</li>
<li>循环引用导致永远无法回收</li>
</ul>
</li>
</ul>
<h2 id="可达性分析"><a href="#可达性分析" class="headerlink" title="可达性分析"></a>可达性分析</h2><ul>
<li>通过一系列名为GC Roots的对象作为起始点，从这些节点开始向下搜索，搜索所走过的路径称为引用链(Reference Chain)，当一个对象到GC Roots没有任何引用链相连时，则证明此对象是不可用的</li>
<li>GC Roots<ul>
<li>虚拟机栈(栈桢中的本地变量表)中的引用的对象</li>
<li>方法区中的类静态属性引用的对象</li>
<li>方法区中的常量引用的对象</li>
<li>本地方法栈中JNI（Native方法）的引用的对象</li>
</ul>
</li>
<li>HotSpot实现：<ul>
<li>使用OopMap记录并枚举根节点<br>方法区太大了（几百兆），所以需要OopMap，在类加载完成时，HotSpot就把对象内什么偏移量上是什么类型的数据计算出来，在JIT编译过程中，也会在特定的位置记录下栈和寄存器中哪些位置是引用。</li>
<li>Safepoint<br>“安全点”简单点说就是程序执行停顿下的这一个点。程序在执行时，并非在所有的地方都能停下来开始GC，只有到达这个“安全点“时才能停顿下来。安全点的选区既不能太少以至于让GC等待时间过长，也不能过于频繁以至于过分增大运行时的负荷。所以，”安全点“的选择基本上是以程序”是否具有让程序长时间执行的特征“为标准来选定的。因为每条执行指令执行的时间都非常地短暂，程序不太可能因为指令流长度太长这个原因而过长时间运行，而程序”长时间的运行“实际上就是指令序列的一个复用。例如方法调用、循环跳转、异常跳转等，所以具有这些功能的指令才会产生”安全点“。而当我们选取好”安全点“之后，我们又是怎样使所有执行线程跑到”安全点“时停顿下来呢？<ul>
<li>中断方式<ul>
<li>抢先式中断：在GC发生时，首次会把所有的线程全部中断，如果发现有些线程中断点不是安全点，就恢复该线程直到安全点上停止。</li>
<li>主动式中断：在GC发生时，不直接操作线程中断，而是简单地设置一个标志，让各个线程执行时主动轮询这个标志，发现中断标志为真时就自己中断挂起。</li>
</ul>
</li>
<li>Safe Region<ul>
<li>安全区域是指在一段代码片中，引用关系不会发生改变，在这个区域内的任意地方开始 GC 都是安全的（比如Thread.sleep()的时候）。当线程执行到安全区域时，首先标识自己已进入安全区域，那样，当在这段时间里JVM要发起GC时，就不用管标识自己为“安全区域”状态的线程了，等到被唤醒时准备离开 Safe Region 时，先检查能否离开，如果 GC 完成了，那么线程可以离开，否则它必须等待直到收到安全离开的信号为止。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h1><h2 id="标记-清除算法（mark-sweep）"><a href="#标记-清除算法（mark-sweep）" class="headerlink" title="标记-清除算法（mark-sweep）"></a>标记-清除算法（mark-sweep）</h2><ul>
<li>标记-&gt;在清除阶段，垃圾收集器会从Java堆中从头到尾进行遍历，如果有对象没有被打上标记，那么这个对象就会被清除。</li>
<li>遍历过程效率低。</li>
<li>会产生很多不连续的空间碎片，所以可能会导致程序运行过程中需要分配较大的对象的时候，多触发几次垃圾回收。</li>
</ul>
<h2 id="复制算法（copying）"><a href="#复制算法（copying）" class="headerlink" title="复制算法（copying）"></a>复制算法（copying）</h2><ul>
<li>复制算法是为了解决标记-清除算法的效率问题的。基本新生代垃圾收集器全部是复制算法。</li>
<li>优点：快，没有碎片。</li>
<li>缺点：浪费内存。</li>
<li>现在的商业虚拟机都采用这种收集算法来回收新生代，新生代中的对象98%是“朝生夕死”的，所以并不需要按照1∶1的比例来划分内存空间，而是将内存分为一块较大的Eden空间和两块较小的Survivor空间，每次使用Eden和其中一块Survivor。当回收时，将Eden和Survivor中还存活着的对象一次性地复制到另外一块Survivor空间上，最后清理掉Eden和刚才用过的Survivor空间。HotSpot虚拟机默认Eden和Survivor的大小比例是8∶1，也就是每次新生代中可用内存空间为整个新生代容量的90%，只有10%的内存会被“浪费”。当然，90%的对象可回收只是一般场景下的数据，我们没有办法保证每次回收都只有不多于10%的对象存活，当Survivor空间不够用时（例如，存活的对象需要的空间大于剩余一块Survivor的空间），需要依赖其他内存（这里指老年代）进行分配担保（Handle Promotion）。<br><img src="https://fanjingdan012.github.io/2019/04/10/GC/Copying.png" alt="Copying"></li>
</ul>
<h2 id="标记-整理算法（mark-compact）"><a href="#标记-整理算法（mark-compact）" class="headerlink" title="标记-整理算法（mark-compact）"></a>标记-整理算法（mark-compact）</h2><ul>
<li>复制收集算法在对象存活率较高时就要进行较多的复制操作，效率将会变低。所以在老年代不用复制算法，而用标记-整理算法。</li>
<li>标记-让所有的存活对象都向一端移动，然后清理掉边界外的内存。</li>
</ul>
<h1 id="垃圾收集器"><a href="#垃圾收集器" class="headerlink" title="垃圾收集器"></a>垃圾收集器</h1><p><img src="https://fanjingdan012.github.io/2019/04/10/GC/Serial.jpg" alt="Serial"><br><img src="https://fanjingdan012.github.io/2019/04/10/GC/ParNew.jpg" alt="ParNew"><br><img src="https://fanjingdan012.github.io/2019/04/10/GC/ParOld.jpg" alt="ParOld"></p>
<p>| 收集器        | 串并       |  新老      |算法|目标|适用场景|优缺点|JVM参数|推出时间|<br>| ————- | ——-    | ——-|———–|————|————-|————-|<br>| Serial        | 串行      |新生代 |复制算法|响应速度优先|单CPU环境下的Client模式默认收集器Java3前唯一选择|简单高效，单CPU首选|-XX:+UseSerialGC||<br>| Serial Old    | 串行      |老年代 |标记-整理|    响应速度优先|    单CPU环境下的Client模式、CMS的后备预案||默认||<br>| ParNew        | 并行      |新生代 |复制算法    |响应速度优先|    多CPU环境时在Server模式下与CMS配合||-XX:+UseParNewGC||<br>|Parallel Scavenge|    并行    |    新生代|复制算法    |吞吐量优先    |多CPU，大Heap（&gt;10GB）在后台运算而不需要太多交互的任务|GC自适应的调节策略：Parallel Scavenge收集器有一个参数-XX:+UseAdaptiveSizePolicy。当这个参数打开之后，就不需要手工指定新生代的大小、Eden与Survivor区的比例、晋升老年代对象年龄等细节参数了，虚拟机会根据当前系统的运行情况收集性能监控信息，动态调整这些参数以提供最合适的停顿时间或者最大的吞吐量，这种调节方式称为GC自适应的调节策略（GC Ergonomics）是和ParNew的最大区别，配合的老年代收集器只有Serial和Parallel Old|-XX:+UseParallelGC XX:MaxGCPauseMills XX:GCTimeRatio(0-100)这俩参数是矛盾的|JDK 1.4.0|<br>|CMS            |    并发      |    老年代|标记-清除|    缩短GC时用户线程的停顿时间|    集中在互联网站或B/S系统服务端上的Java应用|配合的新生代只有ParNew和Serial|-XX:+UseConcMarkSweepGC|JDK1.5|<br>|Parallel Old   |    并行      |    老年代|标记-整理|    吞吐量优先|    在后台运算而不需要太多交互的任务以及CPU资源敏感的场合||-XX:+UseParallelOldGC|JDK 1.6|<br>|G1                 |并发      |    both|标记-整理+复制算法    |响应速度优先|    面向服务端应用，将来替换CMS||-XX:+UseG1GC|JDK1.8|</p>
<p><img src="https://fanjingdan012.github.io/2019/04/10/GC/GC.jpg" alt="收集器配合"></p>
<h2 id="CMS"><a href="#CMS" class="headerlink" title="CMS"></a>CMS</h2><p><img src="https://fanjingdan012.github.io/2019/04/10/GC/CMS.jpg" alt="CMS"></p>
<ul>
<li><p>基于“标记—清除”算法，分4步：</p>
<ol>
<li>初始标记（CMS initial mark）：仅仅只是标记一下GC Roots能直接关联到的对象，速度很快，要STW。</li>
<li>并发标记（CMS concurrent mark）：进行GC Roots Tracing的过程。</li>
<li>重新标记（CMS remark）：为了修正并发标记期间因用户程序继续运作而导致标记产生变动的那一部分对象的标记记录，这个阶段的停顿时间一般会比初始标记阶段稍长一些，但远比并发标记的时间短，要STW。</li>
<li>并发清除（CMS concurrent sweep）</li>
</ol>
</li>
<li><p>缺点：</p>
<ul>
<li>CPU个数太少（&lt;4个）的话，CMS收集器占用CPU导致应用程序变慢，总吞吐量会降低<br>CMS默认启动的回收线程数是（CPU数量+3）/ 4，也就是当CPU在4个以上时，并发回收时垃圾收集线程不少于25%的CPU资源，并且随着CPU数量的增加而下降。但是当CPU不足4个（譬如2个）时，CMS对用户程序的影响就可能变得很大。</li>
<li>CMS收集器无法处理浮动垃圾<br>可能出现“Concurrent Mode Failure”失败而导致另一次Full GC的产生。由于CMS并发清理阶段用户线程还在运行着，伴随程序运行自然就还会有新的垃圾不断产生，这一部分垃圾出现在标记过程之后，CMS无法在当次收集中处理掉它们，只好留待下一次GC时再清理掉。这一部分垃圾就称为“浮动垃圾”。也是由于在垃圾收集阶段用户线程还需要运行，那也就还需要预留有足够的内存空间给用户线程使用，因此CMS收集器不能像其他收集器那样等到老年代几乎完全被填满了再进行收集，需要预留一部分空间提供并发收集时的程序运作使用。要是CMS运行期间预留的内存无法满足程序需要，就会出现一次“Concurrent Mode Failure”失败，这时虚拟机将启动后备预案：临时启用Serial Old收集器来重新进行老年代的垃圾收集，这样停顿时间就很长了。</li>
<li>会产生大量空间碎片</li>
</ul>
</li>
<li><p>GC 参数</p>
<ul>
<li><code>XX:+UseCMSCompactAtFullCollection</code> 是非每次CMS GC以后整理内存</li>
<li><code>XX:CMSFullGCsBeforeCompaction</code> 几次CMS GC以后整理内存</li>
<li><code>XX:+CMSClassUnloadingEnabled</code> 允许Class元数据回收</li>
<li><code>XX:UseCMSInitiatingPermOccupancyFraction</code> 永久区占用率达到多少百分比启动CMS GC</li>
<li><code>XX:UseCMSInitiatingOccupancyOnly</code> 只有达到阈值才进行CMS GC</li>
</ul>
</li>
</ul>
<h2 id="G1"><a href="#G1" class="headerlink" title="G1"></a>G1</h2><p><a target="_blank" rel="noopener" href="https://www.oracle.com/technetwork/articles/java/g1gc-1984535.html">https://www.oracle.com/technetwork/articles/java/g1gc-1984535.html</a><br><img src="https://fanjingdan012.github.io/2019/04/10/GC/G1.jpg" alt="G1"><br>Young GC + mixed GC（新生代，再加上部分老生代）＋ Full GC for G1 GC算法（应对G1 GC算法某些时候的不赶趟，开销很大）；</p>
<ul>
<li>优点<ul>
<li>可预测的停顿<br>这是G1相对于CMS的另一大优势。使用G1收集器时，Java堆的内存布局就与其他收集器有很大差别，它将整个Java堆划分为多个大小相等的独立区域（Region），虽然还保留有新生代和老年代的概念，但新生代和老年代不再是物理隔离的了，它们都是一部分Region（不需要连续）的集合。G1收集器之所以能建立可预测的停顿时间模型，是因为它可以有计划地避免在整个Java堆中进行全区域的垃圾收集。G1跟踪各个Region里面的垃圾堆积的价值大小（回收所获得的空间大小以及回收所需时间的经验值），在后台维护一个优先列表，每次根据允许的收集时间，优先回收价值最大的Region（这也就是Garbage-First名称的来由）。这种使用Region划分内存空间以及有优先级的区域回收方式，保证了G1收集器在有限的时间内可以获取尽可能高的收集效率。</li>
<li>空间整合<br>G1从整体来看是基于“标记—整理”算法实现的收集器，从局部（两个Region之间）上来看是基于“复制”算法实现的，收集后能提供规整的可用内存。</li>
</ul>
</li>
<li>执行过程：<ol>
<li>初始标记（Initial Marking）<br>初始标记阶段仅仅只是标记一下GC Roots能直接关联到的对象，并且修改TAMS（Next Top at Mark Start）的值，让下一阶段用户程序并发运行时，能在正确可用的Region中创建新对象，要STW。</li>
<li>并发标记（Concurrent Marking）</li>
<li>最终标记（Final Marking）<br>最终标记阶段是为了修正在并发标记期间因用户程序继续运作而导致标记产生变动的那一部分标记记录，虚拟机将这段时间对象变化记录在线程Remembered Set Logs里面，最终标记阶段需要把Remembered Set Logs的数据合并到Remembered Set中，这阶段需要停顿线程，但是可并行执行。</li>
<li>筛选回收（Live Data Counting and Evacuation）<br>筛选回收阶段首先对各个Region的回收价值和成本进行排序，根据用户所期望的GC停顿时间来制定回收计划，这个阶段其实也可以做到与用户程序一起并发执行，但是因为只回收一部分Region，时间是用户可控制的，而且停顿用户线程将大幅提高收集效率。</li>
</ol>
</li>
</ul>
<h2 id="Epsilon：低开销垃圾回收器"><a href="#Epsilon：低开销垃圾回收器" class="headerlink" title="Epsilon：低开销垃圾回收器"></a>Epsilon：低开销垃圾回收器</h2><ul>
<li>启动： <code>-XX:+UseEpsilonGC</code></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanjingdan012.github.io/2018/12/04/Spring-Security/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="FJD">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FJD">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/04/Spring-Security/" class="post-title-link" itemprop="url">Spring Security</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-04 16:43:57" itemprop="dateCreated datePublished" datetime="2018-12-04T16:43:57+08:00">2018-12-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-19 17:52:32" itemprop="dateModified" datetime="2021-11-19T17:52:32+08:00">2021-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Computer-Science/" itemprop="url" rel="index"><span itemprop="name">Computer Science</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="SSO-server-Callstack"><a href="#SSO-server-Callstack" class="headerlink" title="SSO server Callstack"></a>SSO server Callstack</h1><ul>
<li>在Spring mvc里call Filter Chain, call到org.springframework.security.web.FilterChainProxy.doFilter （extends GenericFilterBean ）<ul>
<li>这里加装了一个HttpFirewall， 提供firewalledRequest和firewalledResponse，去掉一些危险的请求</li>
</ul>
</li>
<li>然后Filter到熟悉的OncePerRequestFilter，有一个WebAsyncManagerIntegrationFilter继承自它<ul>
<li>就是添加了一个SecurityContextCallableProcessingInterceptor，在处理请求的前后包了一层securityContext，preProcess设置它，postProcess clear它</li>
</ul>
</li>
<li>SecurityContextPersistenceFilter 强制的session管理</li>
<li>HeaderWriterFilter， 写了一些security相关的header</li>
<li>CsrfFilter<ul>
<li>从csrf token repository里load这个request的csrf token， 如果没有csrf token的话，那就generate一个，存csrf token repository。 跟request里带的csrf token比对，不对的话就拦截。</li>
<li>当然，可以设置不需要csrf保护，RequestMatcher requireCsrfProtectionMatcher来决定要不要</li>
<li>example:<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;hidden&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;$&#123;_csrf.parameterName&#125;&#x27;</span> <span class="attr">value</span>=<span class="string">&#x27;$&#123;_csrf.token&#125;&#x27;</span> /&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>LogoutFilter<ul>
<li>Logout是专门用这个来做的</li>
</ul>
</li>
<li>AbstractAuthenticationProcessingFilter<ul>
<li>！核心部分，就是这里验证用户名、密码。</li>
<li>call UsernamePasswordAuthenticationFilter</li>
<li>call ProviderManager.authenticate</li>
<li>call AbstractUserDetailsAuthenticationProvider.authenticate</li>
<li>call DaoAuthenticationProvider.retrieveUser</li>
<li>call this.getUserDetailsService().loadUserByUsername(username)<ul>
<li>这里我们要自己写一个XXXUserDetailsService implements UserDetailsService，实现loadUserByUsername方法就可以。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>oauth/confirm_access<br>前面是一样的，后面又call了：</p>
<ul>
<li>AbstractAuthenticationProcessingFilter<ul>
<li>可以设置需不需要authentication保护</li>
<li>用了strategy模式，自己实现sessionSrategy.onAuthentication, 一般来说会检查session，保证不被fix session攻击</li>
</ul>
</li>
<li>DefaultLoginPageGeneratingFilter<ul>
<li>返回login成功以后的page的</li>
</ul>
</li>
<li>RequestCacheAwareFilter<ul>
<li>加cache</li>
</ul>
</li>
<li>SecurityContextHolderAwareRequestFilter <ul>
<li>把request替换掉了， 用来处理servlet2.5和servlet3不同的request</li>
<li>可以设置以下<ul>
<li>rolePrefix</li>
<li>AuthenticationEntryPoint</li>
<li>AuthenticationManager</li>
<li>LogoutHandler</li>
<li>updateFactory</li>
<li>TrustResolver</li>
</ul>
</li>
</ul>
</li>
<li>AnonymousAuthenticationFilter<ul>
<li>检查securityContext有没有authentication，没有就创建</li>
</ul>
</li>
<li>SessionManagementFilter<ul>
<li>检查authentication，如果有且不是匿名，就触发sessionAuthenticationStrategy.onAuthentication(authentication,request, response)</li>
</ul>
</li>
<li>ExceptionTranslationFilter<ul>
<li>翻译authentication的exception</li>
</ul>
</li>
<li>FilterSecurityInterceptor</li>
<li>WsFilter <ul>
<li>可忽略，only needs to handle WebSocket upgrade requests</li>
</ul>
</li>
<li>然后就回到了正常spring web的FilterChain，经过doDispatch到Controller这里</li>
</ul>
<h1 id="通过-session-cookie-维护-authentication"><a href="#通过-session-cookie-维护-authentication" class="headerlink" title="通过 session/cookie 维护 authentication"></a>通过 session/cookie 维护 authentication</h1><p>请求 <a target="_blank" rel="noopener" href="http://127.0.0.1:8060/client2/index.html">http://127.0.0.1:8060/client2/index.html</a> 需要Cookie: </p>
<ul>
<li>JSESSIONID=90AEBC55CFDCDFD9277A00E654C6A4B4; </li>
<li>PGADMIN_LANGUAGE=en; </li>
<li>PGADMIN_KEY=13d9a244-76c6-46aa-9c66-e32ab9c9e447; </li>
<li>pga4_session=”7e6549b3-743a-4992-9b04-d423caa34fcc!51GhrQLaPDsFNZMsyrY0nD2Lx/g=”</li>
</ul>
<h1 id="SSO-Client"><a href="#SSO-Client" class="headerlink" title="SSO Client"></a>SSO Client</h1><p>@EnableOAuth2Sso<br>marks your service as an OAuth 2.0 Client. This means that it will be responsible for redirecting Resource Owner (end user) to the Authorization Server where the user has to enter their credentials. After it’s done the user is redirected back to the Client with Authorization Code (don’t confuse with Access Code). Then the Client takes the Authorization Code and exchanges it for an Access Token by calling Authorization Server. Only after that, the Client can make a call to a Resource Server with Access Token.</p>
<p>Also, if you take a look into the source code of @EnableOAuth2Sso annotation you will see two interesting things:</p>
<p>@EnableOAuth2Client. This is where your service becomes OAuth 2.0 Client. It makes it possible to forward access token (after it has been exchanged for Authorization Code) to downstream services in case you are calling those services via OAuth2RestTemplate.</p>
<p>@EnableConfigurationProperties(OAuth2SsoProperties.class). OAuth2SsoProperties has only one property String loginPath which is /login by default. This will intercept browser requests to the /login by OAuth2ClientAuthenticationProcessingFilter and will redirect the user to the Authorization Server.</p>
<p><code>application.properties</code><br>security.oauth2.client.client-id=client2<br>security.oauth2.client.client-secret=client2<br>security.oauth2.client.user-authorization-uri=<a target="_blank" rel="noopener" href="http://127.0.0.1:9999/server/oauth/authorize">http://127.0.0.1:9999/server/oauth/authorize</a><br>security.oauth2.client.access-token-uri=<a target="_blank" rel="noopener" href="http://127.0.0.1:9999/server/oauth/token">http://127.0.0.1:9999/server/oauth/token</a><br>security.oauth2.resource.jwt.key-uri=<a target="_blank" rel="noopener" href="http://127.0.0.1:9999/server/oauth/token_key">http://127.0.0.1:9999/server/oauth/token_key</a></p>
<h2 id="请求"><a href="#请求" class="headerlink" title="请求"></a>请求</h2><ul>
<li>client2/index.html<ul>
<li>Cookie: JSESSIONID=F9D6E6701C3446256BBDD3536B4C37A2</li>
<li>response: 302 </li>
</ul>
</li>
<li>client2/login <ul>
<li>Cookie: JSESSIONID=F9D6E6701C3446256BBDD3536B4C37A2</li>
<li>response: 302</li>
</ul>
</li>
<li>server/oauth/authorize?client_id=client2&amp;redirect_uri=<a target="_blank" rel="noopener" href="http://127.0.0.1:8060/client2/login&amp;response_type=code&amp;state=FDAZ6f">http://127.0.0.1:8060/client2/login&amp;response_type=code&amp;state=FDAZ6f</a><ul>
<li>Cookie: JSESSIONID=3E6CBEFE193913C53AC3AAA1C7687C89</li>
<li>response: 302</li>
</ul>
</li>
<li>server/login<ul>
<li>Cookie: JSESSIONID=3E6CBEFE193913C53AC3AAA1C7687C89</li>
<li>response: 200 + login 页面</li>
</ul>
</li>
</ul>
<p>@EnableResourceServer</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanjingdan012.github.io/2018/08/17/Refactor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="FJD">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FJD">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/17/Refactor/" class="post-title-link" itemprop="url">Refactor</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-08-17 12:36:38" itemprop="dateCreated datePublished" datetime="2018-08-17T12:36:38+08:00">2018-08-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-19 17:52:32" itemprop="dateModified" datetime="2021-11-19T17:52:32+08:00">2021-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Computer-Science/" itemprop="url" rel="index"><span itemprop="name">Computer Science</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="principles-checklist-for-refactor"><a href="#principles-checklist-for-refactor" class="headerlink" title="principles/checklist for refactor"></a>principles/checklist for refactor</h1><ul>
<li>small</li>
<li>safe</li>
<li>improve<ul>
<li>readable<ul>
<li>meet with human god feelings</li>
<li>naming correctly</li>
</ul>
</li>
<li>testable</li>
</ul>
</li>
</ul>
<h1 id="good-practice"><a href="#good-practice" class="headerlink" title="good practice"></a>good practice</h1><ul>
<li>don’t modify param</li>
<li>don’t mass up input and output<ul>
<li>e.g. <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Param <span class="title">someMethod</span><span class="params">(Param p)</span></span>&#123;</span><br><span class="line">   <span class="keyword">if</span>(p.getA())&#123;</span><br><span class="line">      p.setB(<span class="string">&quot;a&quot;</span>)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>one responsibility for one method</li>
<li>pass only the parameters needed by method</li>
<li>keep smallest visibility</li>
<li>use design pattern correctly</li>
<li>UT<ul>
<li>can run locally</li>
<li>fast</li>
<li>as doc to tell users how to use the method</li>
</ul>
</li>
</ul>
<h1 id="case-study"><a href="#case-study" class="headerlink" title="case study"></a>case study</h1><h2 id="refactor-long-refreshUserGroup-method"><a href="#refactor-long-refreshUserGroup-method" class="headerlink" title="refactor long refreshUserGroup method"></a>refactor long refreshUserGroup method</h2><h3 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h3><ul>
<li>do update and conditional dispatch in one method</li>
<li>modify parameter</li>
<li>parse whole cmd but use part of the params</li>
<li>no UT, just using testNG(integration test ~20 cases)<ul>
<li>need to run tomcat to run cases</li>
<li>long time to run cases(~7 minutes)</li>
<li>dependency between cases(must run in a certain order)</li>
<li>dependency on db initial data</li>
</ul>
</li>
<li>no pipeline</li>
<li>code too large<ul>
<li>out of memory when running locally</li>
<li>long time to compile(~7 minutes)</li>
</ul>
</li>
<li>after dispached in one case, outside of that class, actually modify the param and call itself for update again</li>
<li>misuse of parameter, eg isrefreshAll actually int, set to _99 to mean another case</li>
<li>cmd execute is common way to implement a service, actually naming is bad, bacause not preventing any information…</li>
</ul>
<h2 id="Actions"><a href="#Actions" class="headerlink" title="Actions"></a>Actions</h2><ul>
<li>separate update logic and dispatch logic</li>
<li>separate input with output</li>
<li>add UT</li>
<li>only pass params that used to methods</li>
</ul>
<h1 id="refactor-30000-line-code-UserDAO"><a href="#refactor-30000-line-code-UserDAO" class="headerlink" title="refactor 30000 line code UserDAO"></a>refactor 30000 line code UserDAO</h1><h2 id="Problem-1"><a href="#Problem-1" class="headerlink" title="Problem"></a>Problem</h2><ul>
<li>too large</li>
<li>own by multiple teams  </li>
<li>user specific logics and application specific logics together</li>
<li>referenced by other modules by jar dependency</li>
</ul>
<h2 id="Actions-1"><a href="#Actions-1" class="headerlink" title="Actions"></a>Actions</h2><ul>
<li>remove unused methods</li>
<li>move some to new user specific logic UserDAO and some to application DAO</li>
<li>make original one a delegate to new ones</li>
<li>add UT</li>
<li>rely on interfaces between modules，interface be small</li>
<li>adapters in caller,学习型测试</li>
</ul>
<h1 id="UT-for-singlton-RuleEngine"><a href="#UT-for-singlton-RuleEngine" class="headerlink" title="UT for singlton RuleEngine"></a>UT for singlton RuleEngine</h1><h2 id="Problem-2"><a href="#Problem-2" class="headerlink" title="Problem"></a>Problem</h2><ul>
<li>different tests for different scenarios</li>
<li>misuse of singleton</li>
<li>class name XXFactory, actually not, it is a singleton and not producing XX Bean</li>
</ul>
<h2 id="Actions-2"><a href="#Actions-2" class="headerlink" title="Actions"></a>Actions</h2><ul>
<li>modify UT to add mock for different scenarios</li>
</ul>
<h1 id="UT-for-smart-controller"><a href="#UT-for-smart-controller" class="headerlink" title="UT for smart controller"></a>UT for smart controller</h1><h2 id="Problem-3"><a href="#Problem-3" class="headerlink" title="Problem"></a>Problem</h2><ul>
<li>too much logic done by smart widgets, not easy to test</li>
</ul>
<h2 id="Actions-3"><a href="#Actions-3" class="headerlink" title="Actions"></a>Actions</h2><ul>
<li>verify if update methods called</li>
<li>some logic move to service level to reuse code</li>
<li>only test code written by you</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">FJD</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">49</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">FJD</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
