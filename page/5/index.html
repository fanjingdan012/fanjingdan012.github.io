<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"fanjingdan012.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="FJD">
<meta property="og:url" content="https://fanjingdan012.github.io/page/5/index.html">
<meta property="og:site_name" content="FJD">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="FJD">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://fanjingdan012.github.io/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>FJD</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">FJD</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-计算机知识树">

    <a href="/CSKT/" rel="section"><i class="fa fa-sitemap fa-fw"></i>计算机知识树</a>

  </li>
        <li class="menu-item menu-item-会计学知识树">

    <a href="/AccountingKT/" rel="section"><i class="fa fa-sitemap fa-fw"></i>会计学知识树</a>

  </li>
        <li class="menu-item menu-item-数学知识树">

    <a href="/MathKT/" rel="section"><i class="fa fa-sitemap fa-fw"></i>数学知识树</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanjingdan012.github.io/2018/08/07/CGLib-Source-Code-Read/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="FJD">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FJD">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/07/CGLib-Source-Code-Read/" class="post-title-link" itemprop="url">CGLib Source Code Read</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-08-07 17:03:46" itemprop="dateCreated datePublished" datetime="2018-08-07T17:03:46+08:00">2018-08-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-19 17:52:32" itemprop="dateModified" datetime="2021-11-19T17:52:32+08:00">2021-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Computer-Science/" itemprop="url" rel="index"><span itemprop="name">Computer Science</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Call-Stack"><a href="#Call-Stack" class="headerlink" title="Call Stack"></a>Call Stack</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">at net.sf.cglib.core.CodeEmitter.visitMaxs(CodeEmitter.java:842)</span><br><span class="line">at net.sf.cglib.core.CodeEmitter.end_method(CodeEmitter.java:138)</span><br><span class="line">at net.sf.cglib.proxy.Enhancer.emitMethods(Enhancer.java:1230)</span><br><span class="line">at net.sf.cglib.proxy.Enhancer.generateClass(Enhancer.java:630)</span><br><span class="line">at net.sf.cglib.core.DefaultGeneratorStrategy.generate(DefaultGeneratorStrategy.java:25)</span><br><span class="line">at net.sf.cglib.core.AbstractClassGenerator.generate(AbstractClassGenerator.java:329)</span><br><span class="line">at net.sf.cglib.proxy.Enhancer.generate(Enhancer.java:492)</span><br><span class="line">at net.sf.cglib.core.AbstractClassGenerator$ClassLoaderData$3.apply(AbstractClassGenerator.java:93)</span><br><span class="line">at net.sf.cglib.core.AbstractClassGenerator$ClassLoaderData$3.apply(AbstractClassGenerator.java:91)</span><br><span class="line">at net.sf.cglib.core.internal.LoadingCache$2.call(LoadingCache.java:54)</span><br><span class="line">at java.util.concurrent.FutureTask.run(FutureTask.java:266)</span><br><span class="line">at net.sf.cglib.core.internal.LoadingCache.createEntry(LoadingCache.java:61)</span><br><span class="line">at net.sf.cglib.core.internal.LoadingCache.get(LoadingCache.java:34)</span><br><span class="line">at net.sf.cglib.core.AbstractClassGenerator$ClassLoaderData.get(AbstractClassGenerator.java:116)</span><br><span class="line">at net.sf.cglib.core.AbstractClassGenerator.create(AbstractClassGenerator.java:291)</span><br><span class="line">at net.sf.cglib.proxy.Enhancer.createHelper(Enhancer.java:480)</span><br><span class="line">at net.sf.cglib.proxy.Enhancer.create(Enhancer.java:305)</span><br><span class="line">at basic.ATest.testFixedValue(ATest.java:34)</span><br></pre></td></tr></table></figure>
<p>底层用的是ASM</p>
<p>Enhancer<br>create()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">createHelper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.preValidate();</span><br><span class="line">        Object key = KEY_FACTORY.newInstance(</span><br><span class="line">            <span class="keyword">this</span>.superclass != <span class="keyword">null</span> ? <span class="keyword">this</span>.superclass.getName() : <span class="keyword">null</span>, <span class="comment">//basic.A</span></span><br><span class="line">            ReflectUtils.getNames(<span class="keyword">this</span>.interfaces), <span class="comment">//null</span></span><br><span class="line">            <span class="keyword">this</span>.filter == ALL_ZERO ? <span class="keyword">null</span> : <span class="keyword">new</span> WeakCacheKey(<span class="keyword">this</span>.filter),<span class="comment">//null</span></span><br><span class="line">            <span class="keyword">this</span>.callbackTypes, <span class="comment">//[Lorg.objectweb.asm.Type;@6b9651f3]</span></span><br><span class="line">            <span class="keyword">this</span>.useFactory,<span class="comment">//true</span></span><br><span class="line">            <span class="keyword">this</span>.interceptDuringConstruction, <span class="comment">//true</span></span><br><span class="line">            <span class="keyword">this</span>.serialVersionUID<span class="comment">//true</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">this</span>.currentKey = key;</span><br><span class="line">        Object result = <span class="keyword">super</span>.create(key);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>this.superclass</code> = basic.A</li>
<li><code>this.filter</code>=ALL_ZERO=<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> CallbackFilter() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">accept</span><span class="params">(Method method)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<code>AbstractClassGenerator.create(Object key)</code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">create</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ClassLoader loader = <span class="keyword">this</span>.getClassLoader();</span><br><span class="line">        Map&lt;ClassLoader, AbstractClassGenerator.ClassLoaderData&gt; cache = CACHE;</span><br><span class="line">        AbstractClassGenerator.ClassLoaderData data = (AbstractClassGenerator.ClassLoaderData)cache.get(loader);</span><br><span class="line">        <span class="keyword">if</span> (data == <span class="keyword">null</span>) &#123;<span class="comment">//这里一般data！=null，所以不走</span></span><br><span class="line">            Class var5 = AbstractClassGenerator.class;</span><br><span class="line">            <span class="keyword">synchronized</span>(AbstractClassGenerator.class) &#123;</span><br><span class="line">                cache = CACHE;</span><br><span class="line">                data = (AbstractClassGenerator.ClassLoaderData)cache.get(loader);</span><br><span class="line">                <span class="keyword">if</span> (data == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Map&lt;ClassLoader, AbstractClassGenerator.ClassLoaderData&gt; newCache = <span class="keyword">new</span> WeakHashMap(cache);</span><br><span class="line">                    data = <span class="keyword">new</span> AbstractClassGenerator.ClassLoaderData(loader);</span><br><span class="line">                    newCache.put(loader, data);</span><br><span class="line">                    CACHE = newCache;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        Object obj = data.get(<span class="keyword">this</span>, <span class="keyword">this</span>.getUseCache());</span><br><span class="line">        <span class="keyword">return</span> obj <span class="keyword">instanceof</span> Class ? <span class="keyword">this</span>.firstInstance((Class)obj) : <span class="keyword">this</span>.nextInstance(obj);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException var9) &#123;</span><br><span class="line">        <span class="keyword">throw</span> var9;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Error var10) &#123;</span><br><span class="line">        <span class="keyword">throw</span> var10;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var11) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CodeGenerationException(var11);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<code>AbstractClassGenerator.gen</code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(AbstractClassGenerator gen, <span class="keyword">boolean</span> useCache)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!useCache) &#123;<span class="comment">//这里=true，所以一直走else</span></span><br><span class="line">        <span class="keyword">return</span> gen.generate(<span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Object cachedValue = <span class="keyword">this</span>.generatedClasses.get(gen);</span><br><span class="line">        <span class="keyword">return</span> gen.unwrapCachedValue(cachedValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
这里只有<code>Object cachedValue = this.generatedClasses.get(gen);</code>最重要，这个get方法如下，其实就是里面维护了个map当cache，cache不命中就<code>this.createEntry(key, cacheKey, v);</code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(K key)</span> </span>&#123;</span><br><span class="line">    KK cacheKey = <span class="keyword">this</span>.keyMapper.apply(key);</span><br><span class="line">    Object v = <span class="keyword">this</span>.map.get(cacheKey);</span><br><span class="line">    <span class="keyword">return</span> v != <span class="keyword">null</span> &amp;&amp; !(v <span class="keyword">instanceof</span> FutureTask) ? v : <span class="keyword">this</span>.createEntry(key, cacheKey, v);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>一开始进来是关于要创建的class A的，然后走到<code>Object obj = data.get(this, this.getUseCache());</code>的时候recursive call 自己</p>
<ol>
<li>第一次进来key=net.sf.cglib.core.MethodWrapper$MethodWrapperKey<ul>
<li>gen=net.sf.cglib.core.KeyFactory$Generator@27f723</li>
<li>generatedClasses=<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;net.sf.cglib.proxy.Enhancer$EnhancerKey=java.lang.ref.WeakReference@7b69c6ba, basic.A, null, null, &#123;Lnet/sf/cglib/proxy/FixedValue;&#125;, true, true, null=java.util.concurrent.FutureTask@46daef40, </span><br><span class="line">net.sf.cglib.core.MethodWrapper$MethodWrapperKey=java.lang.ref.WeakReference@12f41634&#125;</span><br></pre></td></tr></table></figure></li>
<li>返回net.sf.cglib.core.MethodWrapper$MethodWrapperKey$$KeyFactoryByCGLIB$$d45e49f7</li>
</ul>
</li>
<li>第二次进来key=basic.A的一大串，gen=Enhancer,<br>Enhancer.generateClass<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">generateClass</span><span class="params">(ClassVisitor v)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">     Class sc = <span class="keyword">this</span>.superclass == <span class="keyword">null</span> ? Object.class : <span class="keyword">this</span>.superclass;</span><br><span class="line">     <span class="keyword">if</span> (TypeUtils.isFinal(sc.getModifiers())) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Cannot subclass final class &quot;</span> + sc.getName());</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         List constructors = <span class="keyword">new</span> ArrayList(Arrays.asList(sc.getDeclaredConstructors()));</span><br><span class="line">         <span class="keyword">this</span>.filterConstructors(sc, constructors);</span><br><span class="line">         List actualMethods = <span class="keyword">new</span> ArrayList();</span><br><span class="line">         List interfaceMethods = <span class="keyword">new</span> ArrayList();</span><br><span class="line">         <span class="keyword">final</span> Set forcePublic = <span class="keyword">new</span> HashSet();</span><br><span class="line">         getMethods(sc, <span class="keyword">this</span>.interfaces, actualMethods, interfaceMethods, forcePublic);</span><br><span class="line">         List methods = CollectionUtils.transform(actualMethods, <span class="keyword">new</span> Transformer() &#123;</span><br><span class="line">             <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">                 Method method = (Method)value;</span><br><span class="line">                 <span class="keyword">int</span> modifiers = <span class="number">16</span> | method.getModifiers() &amp; -<span class="number">1025</span> &amp; -<span class="number">257</span> &amp; -<span class="number">33</span>;</span><br><span class="line">                 <span class="keyword">if</span> (forcePublic.contains(MethodWrapper.create(method))) &#123;</span><br><span class="line">                     modifiers = modifiers &amp; -<span class="number">5</span> | <span class="number">1</span>;</span><br><span class="line">                 &#125;</span><br><span class="line"></span><br><span class="line">                 <span class="keyword">return</span> ReflectUtils.getMethodInfo(method, modifiers);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;);</span><br><span class="line">         ClassEmitter e = <span class="keyword">new</span> ClassEmitter(v);</span><br><span class="line">         <span class="keyword">if</span> (<span class="keyword">this</span>.currentData == <span class="keyword">null</span>) &#123;</span><br><span class="line">             e.begin_class(<span class="number">46</span>, <span class="number">1</span>, <span class="keyword">this</span>.getClassName(), Type.getType(sc), <span class="keyword">this</span>.useFactory ? TypeUtils.add(TypeUtils.getTypes(<span class="keyword">this</span>.interfaces), FACTORY) : TypeUtils.getTypes(<span class="keyword">this</span>.interfaces), <span class="string">&quot;&lt;generated&gt;&quot;</span>);</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             e.begin_class(<span class="number">46</span>, <span class="number">1</span>, <span class="keyword">this</span>.getClassName(), (Type)<span class="keyword">null</span>, <span class="keyword">new</span> Type[]&#123;FACTORY&#125;, <span class="string">&quot;&lt;generated&gt;&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         List constructorInfo = CollectionUtils.transform(constructors, MethodInfoTransformer.getInstance());</span><br><span class="line">         e.declare_field(<span class="number">2</span>, <span class="string">&quot;CGLIB$BOUND&quot;</span>, Type.BOOLEAN_TYPE, (Object)<span class="keyword">null</span>);</span><br><span class="line">         e.declare_field(<span class="number">9</span>, <span class="string">&quot;CGLIB$FACTORY_DATA&quot;</span>, OBJECT_TYPE, (Object)<span class="keyword">null</span>);</span><br><span class="line">         <span class="keyword">if</span> (!<span class="keyword">this</span>.interceptDuringConstruction) &#123;</span><br><span class="line">             e.declare_field(<span class="number">2</span>, <span class="string">&quot;CGLIB$CONSTRUCTED&quot;</span>, Type.BOOLEAN_TYPE, (Object)<span class="keyword">null</span>);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         e.declare_field(<span class="number">26</span>, <span class="string">&quot;CGLIB$THREAD_CALLBACKS&quot;</span>, THREAD_LOCAL, (Object)<span class="keyword">null</span>);</span><br><span class="line">         e.declare_field(<span class="number">26</span>, <span class="string">&quot;CGLIB$STATIC_CALLBACKS&quot;</span>, CALLBACK_ARRAY, (Object)<span class="keyword">null</span>);</span><br><span class="line">         <span class="keyword">if</span> (<span class="keyword">this</span>.serialVersionUID != <span class="keyword">null</span>) &#123;</span><br><span class="line">             e.declare_field(<span class="number">26</span>, <span class="string">&quot;serialVersionUID&quot;</span>, Type.LONG_TYPE, <span class="keyword">this</span>.serialVersionUID);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.callbackTypes.length; ++i) &#123;</span><br><span class="line">             e.declare_field(<span class="number">2</span>, getCallbackField(i), <span class="keyword">this</span>.callbackTypes[i], (Object)<span class="keyword">null</span>);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         e.declare_field(<span class="number">10</span>, <span class="string">&quot;CGLIB$CALLBACK_FILTER&quot;</span>, OBJECT_TYPE, (Object)<span class="keyword">null</span>);</span><br><span class="line">         <span class="keyword">if</span> (<span class="keyword">this</span>.currentData == <span class="keyword">null</span>) &#123;</span><br><span class="line">             <span class="keyword">this</span>.emitMethods(e, methods, actualMethods);</span><br><span class="line">             <span class="keyword">this</span>.emitConstructors(e, constructorInfo);</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="keyword">this</span>.emitDefaultConstructor(e);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">this</span>.emitSetThreadCallbacks(e);</span><br><span class="line">         <span class="keyword">this</span>.emitSetStaticCallbacks(e);</span><br><span class="line">         <span class="keyword">this</span>.emitBindCallbacks(e);</span><br><span class="line">         <span class="keyword">if</span> (<span class="keyword">this</span>.useFactory || <span class="keyword">this</span>.currentData != <span class="keyword">null</span>) &#123;</span><br><span class="line">             <span class="keyword">int</span>[] keys = <span class="keyword">this</span>.getCallbackKeys();</span><br><span class="line">             <span class="keyword">this</span>.emitNewInstanceCallbacks(e);</span><br><span class="line">             <span class="keyword">this</span>.emitNewInstanceCallback(e);</span><br><span class="line">             <span class="keyword">this</span>.emitNewInstanceMultiarg(e, constructorInfo);</span><br><span class="line">             <span class="keyword">this</span>.emitGetCallback(e, keys);</span><br><span class="line">             <span class="keyword">this</span>.emitSetCallback(e, keys);</span><br><span class="line">             <span class="keyword">this</span>.emitGetCallbacks(e);</span><br><span class="line">             <span class="keyword">this</span>.emitSetCallbacks(e);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         e.end_class();</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
从ClassVisitor名称来看，就是visitor模式，v= DebuggingClassWriter@1014<br>sc=basic.A<br>methods 拿到了所有A的方法，包括Object里继承的<br>methods.toString()=[<br>test(Ljava/lang/String;)Ljava/lang/String;,<br>test1(Ljava/lang/String;)Ljava/lang/String;,<br>equals(Ljava/lang/Object;)Z,<br>toString()Ljava/lang/String;,<br>hashCode()I,<br>clone()Ljava/lang/Object;]</li>
</ol>
<p>ClassEmitter e就是新生成的代理的信息<br>e.classInfo.toString()=basic.A$$EnhancerByCGLIB$$a593fb86<br>basic.A$$EnhancerByCGLIB$$a593fb86 extends A<br>e.fieldInfo={CGLIB$STATIC_CALLBACKS=net.sf.cglib.core.ClassEmitter$FieldInfo@d45d4ff9, CGLIB$CALLBACK_0=net.sf.cglib.core.ClassEmitter$FieldInfo@6cada385, CGLIB$THREAD_CALLBACKS=net.sf.cglib.core.ClassEmitter$FieldInfo@15b3f091, CGLIB$BOUND=net.sf.cglib.core.ClassEmitter$FieldInfo@4050e674, CGLIB$FACTORY_DATA=net.sf.cglib.core.ClassEmitter$FieldInfo@861434f0}</p>
<p>callbackTypes.toString()=[Lorg.objectweb.asm.Type;@50d0686]就是Lnet/sf/cglib/proxy/FixedValue;然后就交给FixedValueGenerator去generate</p>
<h1 id="ASM"><a href="#ASM" class="headerlink" title="ASM"></a>ASM</h1><p>ASM的包里面大量应用了visitor模式，visit package, class, field, method, code block, frame, TryCatchBlock, MultiANewArrayInsn, LocalVariable, LineNumber, MaxsEnd, TypeAnnotation, Parameter.反正就是很细<br>cglib里也有同一套，加了点null判断什么的，然后就调用了ASM对应的visit方法。<br>参考cglib的MethodVisitorTee和asm的MethodWriter</p>
<p>这些XXWriter里就是直接写字节码的了，充斥了各种ByteArray，还有硬编码的字符</p>
<p>不知道Frame是干什么用的，里面的execute方法很震撼。。。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanjingdan012.github.io/2018/08/07/Spring-AOP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="FJD">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FJD">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/07/Spring-AOP/" class="post-title-link" itemprop="url">Spring AOP</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-08-07 10:01:44" itemprop="dateCreated datePublished" datetime="2018-08-07T10:01:44+08:00">2018-08-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-19 17:52:32" itemprop="dateModified" datetime="2021-11-19T17:52:32+08:00">2021-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Computer-Science/" itemprop="url" rel="index"><span itemprop="name">Computer Science</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Spring-AspectJ-概念和术语"><a href="#Spring-AspectJ-概念和术语" class="headerlink" title="Spring AspectJ 概念和术语"></a>Spring AspectJ 概念和术语</h1><p><img src="https://fanjingdan012.github.io/2018/08/07/Spring-AOP/springAop.png" alt="springAop"><br>在JoinPoint方法的PointCut处塞进一段Advice逻辑。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanjingdan012.github.io/2018/08/06/Aspectj-Without-Spring/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="FJD">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FJD">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/06/Aspectj-Without-Spring/" class="post-title-link" itemprop="url">Aspectj Without Spring</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-08-06 16:24:28" itemprop="dateCreated datePublished" datetime="2018-08-06T16:24:28+08:00">2018-08-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-19 17:52:32" itemprop="dateModified" datetime="2021-11-19T17:52:32+08:00">2021-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Computer-Science/" itemprop="url" rel="index"><span itemprop="name">Computer Science</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Install-and-HelloWorld"><a href="#Install-and-HelloWorld" class="headerlink" title="Install and HelloWorld"></a>Install and HelloWorld</h1><p>Follow this<br><a target="_blank" rel="noopener" href="http://zhoujingxian.iteye.com/blog/667214">http://zhoujingxian.iteye.com/blog/667214</a></p>
<h1 id="Src"><a href="#Src" class="headerlink" title="Src"></a>Src</h1><p><code>App.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">aspect AppAspect &#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">around</span><span class="params">()</span>:<span class="title">call</span><span class="params">(<span class="keyword">void</span> App.sayHello()</span>)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;before transaction....&quot;</span>);</span><br><span class="line">        proceed();</span><br><span class="line">        System.out.println(<span class="string">&quot;after transaction....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello AspectJ.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        App app = <span class="keyword">new</span> App();</span><br><span class="line">        app.sayHello();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Decompile"><a href="#Decompile" class="headerlink" title="Decompile"></a>Decompile</h1><p>decompile 千万不要用idea原生的，反编译出来跟源代码没啥区别，要用JD-GUI <a target="_blank" rel="noopener" href="http://jd.benow.ca/">http://jd.benow.ca/</a>  </p>
<h2 id="AppAspect-class"><a href="#AppAspect-class" class="headerlink" title="AppAspect.class"></a>AppAspect.class</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.runtime.internal.AroundClosure;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppAspect</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AppAspect <span class="title">aspectOf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ajc$perSingletonInstance == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> org.aspectj.lang.NoAspectBoundException(<span class="string">&quot;AppAspect&quot;</span>, ajc$initFailureCause);</span><br><span class="line">        <span class="keyword">return</span> ajc$perSingletonInstance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">hasAspect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ajc$perSingletonInstance != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> ajc$postClinit() &#123;</span><br><span class="line">        ajc$perSingletonInstance = <span class="keyword">new</span> AppAspect();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable localThrowable) &#123;</span><br><span class="line">            ajc$initFailureCause = localThrowable;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> ajc$around$AppAspect$<span class="number">1</span>$9ee7cbd2(AroundClosure ajc$aroundClosure) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;before transaction....&quot;</span>);</span><br><span class="line">        ajc$around$AppAspect$<span class="number">1</span>$9ee7cbd2proceed(ajc$aroundClosure);</span><br><span class="line">        System.out.println(<span class="string">&quot;after transaction....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Throwable ajc$initFailureCause;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> AppAspect ajc$perSingletonInstance;</span><br><span class="line"></span><br><span class="line">    AppAspect() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> ajc$around$AppAspect$<span class="number">1</span>$9ee7cbd2proceed(AroundClosure <span class="keyword">this</span>)</span><br><span class="line">            <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="App-class"><a href="#App-class" class="headerlink" title="App.class"></a>App.class</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.runtime.internal.AroundClosure;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> sayHello_aroundBody1$advice(App target, AppAspect ajc$aspectInstance, AroundClosure ajc$aroundClosure) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;before transaction....&quot;</span>);</span><br><span class="line">        AroundClosure localAroundClosure = ajc$aroundClosure;</span><br><span class="line">        sayHello_aroundBody0(target);</span><br><span class="line">        System.out.println(<span class="string">&quot;after transaction....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello AspectJ.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        App app = <span class="keyword">new</span> App();</span><br><span class="line">        App localApp1 = app;</span><br><span class="line">        sayHello_aroundBody1$advice(localApp1, AppAspect.aspectOf(), <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">sayHello_aroundBody0</span><span class="params">(App paramApp)</span> </span>&#123;</span><br><span class="line">        paramApp.sayHello();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">App</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanjingdan012.github.io/2018/08/01/Spring-Source-Code-DefaultListableBeanFactory/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="FJD">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FJD">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/01/Spring-Source-Code-DefaultListableBeanFactory/" class="post-title-link" itemprop="url">Spring Source Code: DefaultListableBeanFactory</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-08-01 14:51:43" itemprop="dateCreated datePublished" datetime="2018-08-01T14:51:43+08:00">2018-08-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-19 17:52:32" itemprop="dateModified" datetime="2021-11-19T17:52:32+08:00">2021-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Computer-Science/" itemprop="url" rel="index"><span itemprop="name">Computer Science</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Call-Stack"><a href="#Call-Stack" class="headerlink" title="Call Stack"></a>Call Stack</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.beans.factory.support.DefaultListableBeanFactory.registerBeanDefinition(DefaultListableBeanFactory.java:792)</span><br><span class="line">org.springframework.context.support.GenericApplicationContext.registerBeanDefinition(GenericApplicationContext.java:321)</span><br><span class="line">org.springframework.context.annotation.AnnotationConfigUtils.registerPostProcessor(AnnotationConfigUtils.java:219)</span><br><span class="line">org.springframework.context.annotation.AnnotationConfigUtils.registerAnnotationConfigProcessors(AnnotationConfigUtils.java:164)</span><br><span class="line">org.springframework.context.annotation.AnnotationConfigUtils.registerAnnotationConfigProcessors(AnnotationConfigUtils.java:135)</span><br><span class="line">org.springframework.context.annotation.AnnotatedBeanDefinitionReader.&lt;init&gt;(AnnotatedBeanDefinitionReader.java:87)</span><br><span class="line">org.springframework.context.annotation.AnnotatedBeanDefinitionReader.&lt;init&gt;(AnnotatedBeanDefinitionReader.java:70)</span><br><span class="line">org.springframework.boot.web.servlet.context.AnnotationConfigServletWebServerApplicationContext.&lt;init&gt;(AnnotationConfigServletWebServerApplicationContext.java:73)</span><br><span class="line">sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)</span><br><span class="line">sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)</span><br><span class="line">sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</span><br><span class="line">java.lang.reflect.Constructor.newInstance(Constructor.java:423)</span><br><span class="line">org.springframework.beans.BeanUtils.instantiateClass(BeanUtils.java:170)</span><br><span class="line">org.springframework.beans.BeanUtils.instantiateClass(BeanUtils.java:124)</span><br><span class="line">org.springframework.boot.SpringApplication.createApplicationContext(SpringApplication.java:595)</span><br><span class="line">org.springframework.boot.SpringApplication.run(SpringApplication.java:321)</span><br><span class="line">org.springframework.boot.SpringApplication.run(SpringApplication.java:1255)</span><br><span class="line">org.springframework.boot.SpringApplication.run(SpringApplication.java:1243)</span><br><span class="line">com.fjd.ssm.SSMApplication.main(SSMApplication.java:14)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanjingdan012.github.io/2018/07/31/Spring-Mvc-Source-code-Request-Handling/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="FJD">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FJD">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/07/31/Spring-Mvc-Source-code-Request-Handling/" class="post-title-link" itemprop="url">Spring Mvc Source code: Request Handling</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-07-31 09:42:07" itemprop="dateCreated datePublished" datetime="2018-07-31T09:42:07+08:00">2018-07-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-19 17:52:32" itemprop="dateModified" datetime="2021-11-19T17:52:32+08:00">2021-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Computer-Science/" itemprop="url" rel="index"><span itemprop="name">Computer Science</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>看看一个request过来是怎么调用到我定义的Controller的。<br>版本是sprin-webmvc:5.0.5.RELEASE<br>以<a target="_blank" rel="noopener" href="https://github.com/fanjingdan012/ssm/tree/multi-tenant%E4%B8%BA%E4%BE%8B">https://github.com/fanjingdan012/ssm/tree/multi-tenant为例</a></p>
<h1 id="Call-stack"><a href="#Call-stack" class="headerlink" title="Call stack"></a>Call stack</h1><p>从下往上读</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">com.fjd.ssm.controller.LoginController.member(LoginController.java:<span class="number">28</span>)</span><br><span class="line">org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:<span class="number">209</span>)</span><br><span class="line">org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:<span class="number">136</span>)</span><br><span class="line">org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:<span class="number">102</span>)</span><br><span class="line">org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:<span class="number">877</span>)</span><br><span class="line">org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:<span class="number">783</span>)</span><br><span class="line">org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:<span class="number">87</span>)</span><br><span class="line">org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:<span class="number">991</span>)</span><br><span class="line">org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:<span class="number">925</span>)</span><br><span class="line">org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:<span class="number">974</span>)</span><br><span class="line">org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:<span class="number">866</span>)</span><br><span class="line">javax.servlet.http.HttpServlet.service(HttpServlet.java:<span class="number">635</span>)</span><br><span class="line">org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:<span class="number">851</span>)</span><br><span class="line">javax.servlet.http.HttpServlet.service(HttpServlet.java:<span class="number">742</span>)</span><br><span class="line"><span class="comment">//3. Filter完，进入正文</span></span><br><span class="line">org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">231</span>)</span><br><span class="line">org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">166</span>)</span><br><span class="line">org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:<span class="number">52</span>)</span><br><span class="line">org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">193</span>)</span><br><span class="line">org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">166</span>)</span><br><span class="line">org.springframework.boot.actuate.metrics.web.servlet.WebMvcMetricsFilter.filterAndRecordMetrics(WebMvcMetricsFilter.java:<span class="number">158</span>)</span><br><span class="line">org.springframework.boot.actuate.metrics.web.servlet.WebMvcMetricsFilter.filterAndRecordMetrics(WebMvcMetricsFilter.java:<span class="number">126</span>)</span><br><span class="line">org.springframework.boot.actuate.metrics.web.servlet.WebMvcMetricsFilter.doFilterInternal(WebMvcMetricsFilter.java:<span class="number">111</span>)</span><br><span class="line">org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">107</span>)</span><br><span class="line">org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">193</span>)</span><br><span class="line">org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">166</span>)</span><br><span class="line">org.springframework.boot.actuate.web.trace.servlet.HttpTraceFilter.doFilterInternal(HttpTraceFilter.java:<span class="number">84</span>)</span><br><span class="line">org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">107</span>)</span><br><span class="line">org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">193</span>)</span><br><span class="line">org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">166</span>)</span><br><span class="line">org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:<span class="number">99</span>)</span><br><span class="line">org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">107</span>)</span><br><span class="line">org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">193</span>)</span><br><span class="line">org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">166</span>)</span><br><span class="line">org.springframework.web.filter.HttpPutFormContentFilter.doFilterInternal(HttpPutFormContentFilter.java:<span class="number">109</span>)</span><br><span class="line">org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">107</span>)</span><br><span class="line">org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">193</span>)</span><br><span class="line">org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">166</span>)</span><br><span class="line">org.springframework.web.filter.HiddenHttpMethodFilter.doFilterInternal(HiddenHttpMethodFilter.java:<span class="number">81</span>)</span><br><span class="line">org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">107</span>)</span><br><span class="line">org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">193</span>)</span><br><span class="line">org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">166</span>)</span><br><span class="line">org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:<span class="number">200</span>)</span><br><span class="line">org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">107</span>)</span><br><span class="line"><span class="comment">//2. 这里开始调用了6个OncePerRequestFilter</span></span><br><span class="line">org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">193</span>)</span><br><span class="line">org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">166</span>)</span><br><span class="line">org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:<span class="number">198</span>)</span><br><span class="line">org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:<span class="number">96</span>)</span><br><span class="line">org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:<span class="number">496</span>)</span><br><span class="line">org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:<span class="number">140</span>)</span><br><span class="line">org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:<span class="number">81</span>)</span><br><span class="line">org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:<span class="number">87</span>)</span><br><span class="line">org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:<span class="number">342</span>)</span><br><span class="line">org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:<span class="number">803</span>)</span><br><span class="line">org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:<span class="number">66</span>)</span><br><span class="line">org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:<span class="number">790</span>)</span><br><span class="line">org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:<span class="number">1459</span>)</span><br><span class="line"><span class="comment">//1. ThreadPoolExecutor和NioEndpoint 可以看一下</span></span><br><span class="line">org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:<span class="number">49</span>)</span><br><span class="line">java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1142</span>)</span><br><span class="line">java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">617</span>)</span><br><span class="line">org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:<span class="number">61</span>)</span><br><span class="line">java.lang.Thread.run(Thread.java:<span class="number">745</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>使用ThreadPoolExecutor调用线程池，并且使用Nio</li>
<li>默认调用了6次OncePerRequestFilter</li>
</ul>
<h1 id="代码和数据"><a href="#代码和数据" class="headerlink" title="代码和数据"></a>代码和数据</h1><h2 id="filterChain"><a href="#filterChain" class="headerlink" title="filterChain"></a>filterChain</h2><p><img src="/.io//filterChain.PNG" alt="filterChain"><br>有7个filter，调用到自己写的Controller正好是第6个：WebMvcMetricsFilter，这7个Filter都可以去看看源代码，处理了什么。有几个很明显的处理Encoding，Context。</p>
<h3 id="这个filterChain哪来的呢？"><a href="#这个filterChain哪来的呢？" class="headerlink" title="这个filterChain哪来的呢？"></a>这个filterChain哪来的呢？</h3><p>ApplicationFilterChain 193行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//chain=this</span></span><br><span class="line">filter.doFilter(request, response, <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>
<p>就是说filterChain就是ApplicationFilterChain<br>里面维护了一个<code>ApplicationFilterConfig[] filters</code>数组，确实里面就是7个Filter<br>这个数组的维护代码在<code>ApplicationFilterFactory.createFilterChain</code>115行和131行，调用了<code>ApplicationFilterChain.addFilter(filterConfig)</code>，这个<code>createFilterChain</code>也是每个request都要调用一遍<br>3个参数是什么呢？</p>
<ul>
<li>request不用说了吧</li>
<li>wrapper<br><img src="/.io//wrapper.PNG" alt="wrapper"><br><img src="/.io//wrapper2.PNG" alt="wrapper2"></li>
<li>servlet<br><img src="/.io//servlet.PNG" alt="servlet"><br>这个时候filterChain里还是空的<br><code>ApplicationFilterFactory.java</code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ApplicationFilterChain <span class="title">createFilterChain</span><span class="params">(ServletRequest request,</span></span></span><br><span class="line"><span class="params"><span class="function">            Wrapper wrapper, Servlet servlet)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If there is no servlet to execute, return null</span></span><br><span class="line">        <span class="keyword">if</span> (servlet == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create and initialize a filter chain object</span></span><br><span class="line">        ApplicationFilterChain filterChain = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (request <span class="keyword">instanceof</span> Request) &#123;<span class="comment">//1.这里=true</span></span><br><span class="line">            Request req = (Request) request;</span><br><span class="line">            <span class="keyword">if</span> (Globals.IS_SECURITY_ENABLED) &#123;<span class="comment">//2.这里=false</span></span><br><span class="line">                <span class="comment">// Security: Do not recycle</span></span><br><span class="line">                filterChain = <span class="keyword">new</span> ApplicationFilterChain();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                filterChain = (ApplicationFilterChain) req.getFilterChain();<span class="comment">//3.其实就是走了这一句</span></span><br><span class="line">                <span class="keyword">if</span> (filterChain == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    filterChain = <span class="keyword">new</span> ApplicationFilterChain();</span><br><span class="line">                    req.setFilterChain(filterChain);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Request dispatcher in use</span></span><br><span class="line">            filterChain = <span class="keyword">new</span> ApplicationFilterChain();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        filterChain.setServlet(servlet);</span><br><span class="line">        filterChain.setServletSupportsAsync(wrapper.isAsyncSupported());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Acquire the filter mappings for this Context</span></span><br><span class="line">        <span class="comment">//4.!!!这里挺关键的，拿到了wrapper.getParent(), 这个context就是</span></span><br><span class="line">        StandardContext context = (StandardContext) wrapper.getParent();</span><br><span class="line">        FilterMap filterMaps[] = context.findFilterMaps();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If there are no filter mappings, we are done</span></span><br><span class="line">        <span class="keyword">if</span> ((filterMaps == <span class="keyword">null</span>) || (filterMaps.length == <span class="number">0</span>))</span><br><span class="line">            <span class="keyword">return</span> (filterChain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Acquire the information we will need to match filter mappings</span></span><br><span class="line">        DispatcherType dispatcher =<span class="comment">//5.=&quot;REQUEST&quot;</span></span><br><span class="line">                (DispatcherType) request.getAttribute(Globals.DISPATCHER_TYPE_ATTR);</span><br><span class="line"></span><br><span class="line">        String requestPath = <span class="keyword">null</span>;</span><br><span class="line">        Object attribute = request.getAttribute(Globals.DISPATCHER_REQUEST_PATH_ATTR);</span><br><span class="line">        <span class="keyword">if</span> (attribute != <span class="keyword">null</span>)&#123;</span><br><span class="line">            requestPath = attribute.toString();</span><br><span class="line">        &#125;<span class="comment">//6.attribute=&quot;/members/fjd&quot;</span></span><br><span class="line"></span><br><span class="line">        String servletName = wrapper.getName();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//7.这里就是匹配一下request，把相关的放进filterChain里，这次request是全部都放进去了</span></span><br><span class="line">        <span class="comment">// Add the relevant path-mapped filters to this filter chain</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filterMaps.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!matchDispatcher(filterMaps[i] ,dispatcher)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!matchFiltersURL(filterMaps[i], requestPath))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            ApplicationFilterConfig filterConfig = (ApplicationFilterConfig)</span><br><span class="line">                context.findFilterConfig(filterMaps[i].getFilterName());</span><br><span class="line">            <span class="keyword">if</span> (filterConfig == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// FIXME - log configuration problem</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            filterChain.addFilter(filterConfig);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//8.这里filterChain已经有7个了</span></span><br><span class="line">        <span class="comment">// Add filters that match on servlet name second</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filterMaps.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!matchDispatcher(filterMaps[i] ,dispatcher)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//9.这里servletName=dispatcherServlet</span></span><br><span class="line">            <span class="keyword">if</span> (!matchFiltersServlet(filterMaps[i], servletName))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            ApplicationFilterConfig filterConfig = (ApplicationFilterConfig)</span><br><span class="line">                context.findFilterConfig(filterMaps[i].getFilterName());</span><br><span class="line">            <span class="keyword">if</span> (filterConfig == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// FIXME - log configuration problem</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//10.这里没走到</span></span><br><span class="line">            filterChain.addFilter(filterConfig);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Return the completed filter chain</span></span><br><span class="line">        <span class="keyword">return</span> filterChain;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
注释4这里拿到的context是TomcatEmbeddedContext，已经到了spring boot内嵌的tomcat的包里<br><img src="/.io//wrapperParentContext.PNG" alt="wrapperParentContext"><br>后面一句话就直接拿到了7个filter：<br><img src="/.io//filterMaps.PNG" alt="filterMaps"><br>也就是说filter全部都是来自TomcatEmbeddedContext，那这个是哪来的呢？(TODO)<h2 id="handler"><a href="#handler" class="headerlink" title="handler"></a>handler</h2>在<code>DispatcherServlet.doDispatch</code> 991行正式去调用注册的controller<h3 id="这个handler哪来的"><a href="#这个handler哪来的" class="headerlink" title="这个handler哪来的"></a>这个handler哪来的</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Determine handler adapter for the current request.</span></span><br><span class="line"> HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());</span><br></pre></td></tr></table></figure>
就是<code>mappedHandler.getHandler()</code>拿到的<br>mappedHandler是个HandlerExecutionChain，那里有什么东西呢<br><img src="/.io//mappedHandler.PNG" alt="mappedHandler"><br>里面的东西有：</li>
<li>handler，就是描述Controller里注册的那个方法的，还包含了它对应的beanFactory，就是DefaultListableBeanFactory</li>
<li>interceptors，里面有两个intercepter，是Spring默认就注册了的<ul>
<li>conversionService WebConversionService，看起来里面就注册了一个converter，就是处理Date和Long的转换的</li>
<li>resourceUriProvider resourceUriProvider，这里放了一些path mapper之类的东西，把基础的静态的path map了一下</li>
</ul>
</li>
</ul>
<h3 id="mappedHandler哪来的"><a href="#mappedHandler哪来的" class="headerlink" title="mappedHandler哪来的"></a>mappedHandler哪来的</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mappedHandler = getHandler(processedRequest);</span><br></pre></td></tr></table></figure>
<p>看<code>DispatcherServlet.getHandler</code>代码，是<code>DispatcherServlet.handlerMappings</code>成员变量里根据request匹配到的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> HandlerExecutionChain <span class="title">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">            <span class="keyword">for</span> (HandlerMapping hm : <span class="keyword">this</span>.handlerMappings) &#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="comment">//1.核心就这一句</span></span><br><span class="line">                HandlerExecutionChain handler = hm.getHandler(request);</span><br><span class="line">                <span class="keyword">if</span> (handler != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> handler;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="handlerMappings里面有什么"><a href="#handlerMappings里面有什么" class="headerlink" title="handlerMappings里面有什么"></a>handlerMappings里面有什么</h3><p><img src="/.io//handlerMappings.PNG" alt="handlerMappings"></p>
<h3 id="getHandler是怎么匹配的"><a href="#getHandler是怎么匹配的" class="headerlink" title="getHandler是怎么匹配的"></a>getHandler是怎么匹配的</h3><p>这个<code>HandlerMapping</code>有两个implementation，这里是<code>AbstractHandlerMapping</code>，所以调用的是<code>AbstractHandlerMapping.getHandler</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> HandlerExecutionChain <span class="title">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">//1.最核心就是这句</span></span><br><span class="line">    Object handler = getHandlerInternal(request);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//2.后面是handler还有个default，如果default也没有就返回null</span></span><br><span class="line">    <span class="comment">//3.再后面是从handler组装一个HandlerExecutionChain出来</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AbstractHandlerMapping.getHandlerInternal 是个Abstract方法，有4个实现，在这里call的是<code>AbstractUrlHandlerMapping.java</code>的<code>getHandlerInternal</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getHandlerInternal</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String lookupPath = getUrlPathHelper().getLookupPathForRequest(request);<span class="comment">//1. lookupPath=&quot;/members/fjd&quot;</span></span><br><span class="line">    Object handler = lookupHandler(lookupPath, request);<span class="comment">//2.最核心就是这句</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//3.后面是handler找不到有个rootHandler，再没有有个defaultHandler,如果handler是以name表示的话再去context里getBean，再把这个root或者defaultHandler包一下，但是这些都不重要，大多数情况下都是在2这里就完成了</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后就看一下lookupHandler的实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">lookupHandler</span><span class="params">(String urlPath, HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">//1. 是在handlerMap里找匹配，支持urlPath直接匹配，这个优先于pattern匹配</span></span><br><span class="line">    <span class="comment">// Direct match?</span></span><br><span class="line">    Object handler = <span class="keyword">this</span>.handlerMap.get(urlPath);</span><br><span class="line">    <span class="keyword">if</span> (handler != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Bean name or resolved handler?</span></span><br><span class="line">        <span class="keyword">if</span> (handler <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            String handlerName = (String) handler;</span><br><span class="line">            handler = obtainApplicationContext().getBean(handlerName);</span><br><span class="line">        &#125;</span><br><span class="line">        validateHandler(handler, request);</span><br><span class="line">        <span class="keyword">return</span> buildPathExposingHandler(handler, urlPath, urlPath, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 支持urlPath pattern 匹配</span></span><br><span class="line">    <span class="comment">// Pattern match?</span></span><br><span class="line">    List&lt;String&gt; matchingPatterns = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String registeredPattern : <span class="keyword">this</span>.handlerMap.keySet()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (getPathMatcher().match(registeredPattern, urlPath)) &#123;</span><br><span class="line">            matchingPatterns.add(registeredPattern);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (useTrailingSlashMatch()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!registeredPattern.endsWith(<span class="string">&quot;/&quot;</span>) &amp;&amp; getPathMatcher().match(registeredPattern + <span class="string">&quot;/&quot;</span>, urlPath)) &#123;</span><br><span class="line">                matchingPatterns.add(registeredPattern +<span class="string">&quot;/&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String bestMatch = <span class="keyword">null</span>;</span><br><span class="line">    Comparator&lt;String&gt; patternComparator = getPathMatcher().getPatternComparator(urlPath);</span><br><span class="line">    <span class="keyword">if</span> (!matchingPatterns.isEmpty()) &#123;</span><br><span class="line">        matchingPatterns.sort(patternComparator);</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;Matching patterns for request [&quot;</span> + urlPath + <span class="string">&quot;] are &quot;</span> + matchingPatterns);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3.如果有一堆匹配，只取第一个</span></span><br><span class="line">        bestMatch = matchingPatterns.get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (bestMatch != <span class="keyword">null</span>) &#123;</span><br><span class="line">        handler = <span class="keyword">this</span>.handlerMap.get(bestMatch);</span><br><span class="line">        <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//4.这里保证path结尾有没有&quot;/&quot;都一样</span></span><br><span class="line">            <span class="keyword">if</span> (bestMatch.endsWith(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">                handler = <span class="keyword">this</span>.handlerMap.get(bestMatch.substring(<span class="number">0</span>, bestMatch.length() - <span class="number">1</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                        <span class="string">&quot;Could not find handler for best pattern match [&quot;</span> + bestMatch + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Bean name or resolved handler?</span></span><br><span class="line">        <span class="keyword">if</span> (handler <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            String handlerName = (String) handler;</span><br><span class="line">            handler = obtainApplicationContext().getBean(handlerName);</span><br><span class="line">        &#125;</span><br><span class="line">        validateHandler(handler, request);</span><br><span class="line">        String pathWithinMapping = getPathMatcher().extractPathWithinPattern(bestMatch, urlPath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// There might be multiple &#x27;best patterns&#x27;, let&#x27;s make sure we have the correct URI template variables</span></span><br><span class="line">        <span class="comment">// for all of them</span></span><br><span class="line">        Map&lt;String, String&gt; uriTemplateVariables = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String matchingPattern : matchingPatterns) &#123;</span><br><span class="line">            <span class="keyword">if</span> (patternComparator.compare(bestMatch, matchingPattern) == <span class="number">0</span>) &#123;</span><br><span class="line">                Map&lt;String, String&gt; vars = getPathMatcher().extractUriTemplateVariables(matchingPattern, urlPath);</span><br><span class="line">                Map&lt;String, String&gt; decodedVars = getUrlPathHelper().decodePathVariables(request, vars);</span><br><span class="line">                uriTemplateVariables.putAll(decodedVars);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;URI Template variables for request [&quot;</span> + urlPath + <span class="string">&quot;] are &quot;</span> + uriTemplateVariables);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> buildPathExposingHandler(handler, bestMatch, pathWithinMapping, uriTemplateVariables);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// No handler found...</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>this.handlerMap里其实不会有所有的注册的Mapping，比如本次进来就只有1条，是favico的路径，每次进去都是不一样的handlerMap。 </p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>到这里为止已经探究了filterChain的来源和handler怎么匹配的源代码。<br>这次就先到这儿吧。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanjingdan012.github.io/2018/07/30/Spring-Import-Source-code/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="FJD">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FJD">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/07/30/Spring-Import-Source-code/" class="post-title-link" itemprop="url">Spring Source Code: ImportBeanDefinitionRegistrar</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-07-30 10:56:37" itemprop="dateCreated datePublished" datetime="2018-07-30T10:56:37+08:00">2018-07-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-19 17:52:32" itemprop="dateModified" datetime="2021-11-19T17:52:32+08:00">2021-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Computer-Science/" itemprop="url" rel="index"><span itemprop="name">Computer Science</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Spring 源码阅读<br>以<a target="_blank" rel="noopener" href="https://github.com/fanjingdan012/ssm/tree/multi-tenant%E4%B8%BA%E4%BE%8B%EF%BC%8C%E7%9C%8B%E6%BA%90%E7%A0%81%E4%B8%80%E5%AE%9A%E8%A6%81%E9%85%8D%E5%90%88%E6%95%B0%E6%8D%AE%E7%9C%8B%EF%BC%8C%E5%90%A6%E5%88%99%E5%AE%B9%E6%98%93%E8%BF%B7%E5%A4%B1%E5%9C%A8%E4%BB%A3%E7%A0%81%E9%87%8C">https://github.com/fanjingdan012/ssm/tree/multi-tenant为例，看源码一定要配合数据看，否则容易迷失在代码里</a></p>
<h1 id="调用顺序"><a href="#调用顺序" class="headerlink" title="调用顺序"></a>调用顺序</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">st=&gt;start: Start|past:&gt;https://github.com/fanjingdan012/ssm/tree/multi-tenant[blank]</span><br><span class="line">op16=&gt;operation: org.springframework.context.annotation.ConfigurationClassBeanDefinitionReader.loadBeanDefinitionsFromRegistrars(ConfigurationClassBeanDefinitionReader.java:356)</span><br><span class="line">op15=&gt;operation: org.springframework.context.annotation.ConfigurationClassBeanDefinitionReader.loadBeanDefinitionsForConfigurationClass(ConfigurationClassBeanDefinitionReader.java:144)</span><br><span class="line">op14=&gt;operation: org.springframework.context.annotation.ConfigurationClassBeanDefinitionReader.loadBeanDefinitions(ConfigurationClassBeanDefinitionReader.java:117)</span><br><span class="line">op13=&gt;operation: org.springframework.context.annotation.ConfigurationClassPostProcessor.processConfigBeanDefinitions(ConfigurationClassPostProcessor.java:328)</span><br><span class="line">op12=&gt;operation: org.springframework.context.annotation.ConfigurationClassPostProcessor.postProcessBeanDefinitionRegistry(ConfigurationClassPostProcessor.java:233)</span><br><span class="line">op11=&gt;operation: org.springframework.context.support.PostProcessorRegistrationDelegate.invokeBeanDefinitionRegistryPostProcessors(PostProcessorRegistrationDelegate.java:273)</span><br><span class="line">op10=&gt;operation: org.springframework.context.support.PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(PostProcessorRegistrationDelegate.java:93)</span><br><span class="line">op9=&gt;operation: org.springframework.context.support.AbstractApplicationContext.invokeBeanFactoryPostProcessors(AbstractApplicationContext.java:694)</span><br><span class="line">op8=&gt;operation: org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:532)</span><br><span class="line">op2=&gt;operation: ...</span><br><span class="line">op1=&gt;operation: com.fjd.ssm.SSMApplication.main(SSMApplication.java:14)</span><br><span class="line">st-&gt;op1-&gt;op2-&gt;op8-&gt;op9-&gt;op10-&gt;op11-&gt;op12-&gt;op13-&gt;op14-&gt;op15-&gt;op16</span><br></pre></td></tr></table></figure>
<h1 id="ConfigurationClassBeanDefinitionReader的数据"><a href="#ConfigurationClassBeanDefinitionReader的数据" class="headerlink" title="ConfigurationClassBeanDefinitionReader的数据"></a>ConfigurationClassBeanDefinitionReader的数据</h1><h2 id="成员变量"><a href="#成员变量" class="headerlink" title="成员变量"></a>成员变量</h2><ul>
<li>BeanDefinitionRegistry registry;<br><img src="/.io//register.png" alt="DefaultListableBeanFactory"><br>是DefaultListableBeanFactory，里面还维护了一个beanDefinitionMap，包含了<code>SSMApplication</code>（程序入口）,<code>Controller</code>,<code>Configuration</code>,<code>Service</code>,<code>DataSource</code>,还有Spring自己的一些Processor等，其中自己注册的都是Generic bean，而Spring自己的都是Root bean</li>
<li>ResourceLoader resourceLoader;<br><img src="/.io//resourceLoader.png" alt="AnnotationConfigServletWebServerApplicationContext"><br>是AnnotationConfigServletWebServerApplicationContext</li>
<li>Environment environment<br><img src="/.io//environment.png" alt="StandardServletEnvironment"><br>是StandardServletEnvironment，里面指定了activeProfiles，defaultProfiles，都是LinkedHashSet（非线程安全）的，里面还有个propertySources不知道是干什么的<h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2></li>
<li>在<code>loadBeanDefinitions(Set&lt;ConfigurationClass&gt; configurationModel) </code>里传进去的参数里已经有124个·<code>ConfigurationClass</code>了<br><img src="/.io//configurationModel.png" alt="LinkedHashSet"><br>有自己定义的<code>Service</code>，<code>Controller</code>，<code>SSMApplication</code>，<code>Configuration</code>，还有Spring的一系列Configuration，大多数在autoconfigure包里，包括servlet层的一些Dispatcher，出错处理等，还有jdbc的一系列配置，最后还有Mybatis的<code>MybatisAutoConfiguration</code>，还有很细节的一些json处理等等之类的Configuration。有空应该去看看这些源代码是干了什么。<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><code>ConfigurationClassBeanDefinitionReader.java</code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(Set&lt;ConfigurationClass&gt; configurationModel)</span> </span>&#123;</span><br><span class="line">    TrackedConditionEvaluator trackedConditionEvaluator = <span class="keyword">new</span> TrackedConditionEvaluator();</span><br><span class="line">    <span class="keyword">for</span> (ConfigurationClass configClass : configurationModel) &#123;</span><br><span class="line">        loadBeanDefinitionsForConfigurationClass(configClass, trackedConditionEvaluator);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
对刚才的124个ConfigurationClass逐个load<br>loadBeanDefinitionsForConfigurationClass是要干什么事呢？ 处理了Import的loadBeanDefinitions，调用了register的registerBeanDefinitions方法<br><code>ConfigurationClassBeanDefinitionReader.java</code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitionsForConfigurationClass</span><span class="params">(ConfigurationClass configClass,</span></span></span><br><span class="line"><span class="params"><span class="function">            TrackedConditionEvaluator trackedConditionEvaluator)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (trackedConditionEvaluator.shouldSkip(configClass)) &#123;</span><br><span class="line">            String beanName = configClass.getBeanName();</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.hasLength(beanName) &amp;&amp; <span class="keyword">this</span>.registry.containsBeanDefinition(beanName)) &#123;</span><br><span class="line">                <span class="keyword">this</span>.registry.removeBeanDefinition(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.importRegistry.removeImportingClass(configClass.getMetadata().getClassName());</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (configClass.isImported()) &#123;</span><br><span class="line">            registerBeanDefinitionForImportedConfigurationClass(configClass);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (BeanMethod beanMethod : configClass.getBeanMethods()) &#123;</span><br><span class="line">            loadBeanDefinitionsForBeanMethod(beanMethod);</span><br><span class="line">        &#125;</span><br><span class="line">        loadBeanDefinitionsFromImportedResources(configClass.getImportedResources());</span><br><span class="line">        loadBeanDefinitionsFromRegistrars(configClass.getImportBeanDefinitionRegistrars());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>registerBeanDefinitions方法最主要就是call DefaultListableBeanFactory的 registerBeanDefinition方法。 这个registerBeanDefinition其实就是维护DefaultListableBeanFactory的成员变量：</p>
<ul>
<li>beanDefinitionMap</li>
<li>beanDefinitionNames</li>
<li>manualSingletonNames<br>这些Map基本上都用了ConcurrentHashMap，保证线程安全，也保证有一定的performance。<br>对已有的bean做更新（Override），或者add，或者remove<br><code>DefaultListableBeanFactory.java</code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Assert.hasText(beanName, <span class="string">&quot;Bean name must not be empty&quot;</span>);</span><br><span class="line">        Assert.notNull(beanDefinition, <span class="string">&quot;BeanDefinition must not be null&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (beanDefinition <span class="keyword">instanceof</span> AbstractBeanDefinition) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ((AbstractBeanDefinition) beanDefinition).validate();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(beanDefinition.getResourceDescription(), beanName,</span><br><span class="line">                        <span class="string">&quot;Validation of bean definition failed&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        BeanDefinition oldBeanDefinition;</span><br><span class="line"></span><br><span class="line">        oldBeanDefinition = <span class="keyword">this</span>.beanDefinitionMap.get(beanName);</span><br><span class="line">        <span class="keyword">if</span> (oldBeanDefinition != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!isAllowBeanDefinitionOverriding()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(beanDefinition.getResourceDescription(), beanName,</span><br><span class="line">                        <span class="string">&quot;Cannot register bean definition [&quot;</span> + beanDefinition + <span class="string">&quot;] for bean &#x27;&quot;</span> + beanName +</span><br><span class="line">                        <span class="string">&quot;&#x27;: There is already [&quot;</span> + oldBeanDefinition + <span class="string">&quot;] bound.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (oldBeanDefinition.getRole() &lt; beanDefinition.getRole()) &#123;</span><br><span class="line">                <span class="comment">// e.g. was ROLE_APPLICATION, now overriding with ROLE_SUPPORT or ROLE_INFRASTRUCTURE</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isWarnEnabled()) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.logger.warn(<span class="string">&quot;Overriding user-defined bean definition for bean &#x27;&quot;</span> + beanName +</span><br><span class="line">                            <span class="string">&quot;&#x27; with a framework-generated bean definition: replacing [&quot;</span> +</span><br><span class="line">                            oldBeanDefinition + <span class="string">&quot;] with [&quot;</span> + beanDefinition + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!beanDefinition.equals(oldBeanDefinition)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isInfoEnabled()) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.logger.info(<span class="string">&quot;Overriding bean definition for bean &#x27;&quot;</span> + beanName +</span><br><span class="line">                            <span class="string">&quot;&#x27; with a different definition: replacing [&quot;</span> + oldBeanDefinition +</span><br><span class="line">                            <span class="string">&quot;] with [&quot;</span> + beanDefinition + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isDebugEnabled()) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.logger.debug(<span class="string">&quot;Overriding bean definition for bean &#x27;&quot;</span> + beanName +</span><br><span class="line">                            <span class="string">&quot;&#x27; with an equivalent definition: replacing [&quot;</span> + oldBeanDefinition +</span><br><span class="line">                            <span class="string">&quot;] with [&quot;</span> + beanDefinition + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (hasBeanCreationStarted()) &#123;</span><br><span class="line">                <span class="comment">// Cannot modify startup-time collection elements anymore (for stable iteration)</span></span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="keyword">this</span>.beanDefinitionMap) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">                    List&lt;String&gt; updatedDefinitions = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.beanDefinitionNames.size() + <span class="number">1</span>);</span><br><span class="line">                    updatedDefinitions.addAll(<span class="keyword">this</span>.beanDefinitionNames);</span><br><span class="line">                    updatedDefinitions.add(beanName);</span><br><span class="line">                    <span class="keyword">this</span>.beanDefinitionNames = updatedDefinitions;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.manualSingletonNames.contains(beanName)) &#123;</span><br><span class="line">                        Set&lt;String&gt; updatedSingletons = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="keyword">this</span>.manualSingletonNames);</span><br><span class="line">                        updatedSingletons.remove(beanName);</span><br><span class="line">                        <span class="keyword">this</span>.manualSingletonNames = updatedSingletons;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Still in startup registration phase</span></span><br><span class="line">                <span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">                <span class="keyword">this</span>.beanDefinitionNames.add(beanName);</span><br><span class="line">                <span class="keyword">this</span>.manualSingletonNames.remove(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.frozenBeanDefinitionNames = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (oldBeanDefinition != <span class="keyword">null</span> || containsSingleton(beanName)) &#123;</span><br><span class="line">            resetBeanDefinition(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanjingdan012.github.io/2018/07/27/Spring-Mybatis-Dynamic-DataSource/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="FJD">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FJD">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/07/27/Spring-Mybatis-Dynamic-DataSource/" class="post-title-link" itemprop="url">Spring + Mybatis Dynamic DataSource</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-07-27 13:36:33" itemprop="dateCreated datePublished" datetime="2018-07-27T13:36:33+08:00">2018-07-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-19 17:52:32" itemprop="dateModified" datetime="2021-11-19T17:52:32+08:00">2021-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Computer-Science/" itemprop="url" rel="index"><span itemprop="name">Computer Science</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>为了做隔离性比较好的multi-tenant app，决定做schema based multi-tenant，这就需要</p>
<ul>
<li>Runtime切换DataSource</li>
<li>为了使添加新tenant不用重启，最好还能实现Runtime添加DataSource  </li>
</ul>
<p>所以分2步实现这两个功能。  </p>
<p>代码：<a target="_blank" rel="noopener" href="https://github.com/fanjingdan012/ssm">https://github.com/fanjingdan012/ssm</a><br>目前有3个branch</p>
<ul>
<li>master是基础版Spring+Mybatis+Mariadb，能Read一个DataSource</li>
<li>multi-data-source是实现Runtime切换DataSource的</li>
<li>multi-tenant是实现现Runtime添加DataSource的  </li>
</ul>
<h1 id="预先定义DataSource，Runtime切换"><a href="#预先定义DataSource，Runtime切换" class="headerlink" title="预先定义DataSource，Runtime切换"></a>预先定义DataSource，Runtime切换</h1><h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><ul>
<li>数据库准备，这里用了mariadb，用了两个schema， test和test2，里面是同样的一张member表，插入一点不同的数据<br><img src="https://img-blog.csdn.net/201807231521545?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2ZhbmppbmdkYW4=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></li>
<li>用header控制Tenant-ID，从而访问不同的DataSource<br><img src="https://img-blog.csdn.net/20180723152505201?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2ZhbmppbmdkYW4=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2>写一个MultitenantDataSource.java, <code>MultitenantDataSource extends AbstractRoutingDataSource</code>  </li>
</ul>
<p>看一下<code>AbstractRoutingDataSource</code>的源代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> DataSource <span class="title">determineTargetDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	Assert.notNull(<span class="keyword">this</span>.resolvedDataSources, <span class="string">&quot;DataSource router not initialized&quot;</span>);</span><br><span class="line">	Object lookupKey = determineCurrentLookupKey();</span><br><span class="line">	DataSource dataSource = <span class="keyword">this</span>.resolvedDataSources.get(lookupKey);</span><br><span class="line">	<span class="keyword">if</span> (dataSource == <span class="keyword">null</span> &amp;&amp; (<span class="keyword">this</span>.lenientFallback || lookupKey == <span class="keyword">null</span>)) &#123;</span><br><span class="line">		dataSource = <span class="keyword">this</span>.resolvedDefaultDataSource;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (dataSource == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Cannot determine target DataSource for lookup key [&quot;</span> + lookupKey + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> dataSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>里面有一个<code>resolvedDataSources</code>的Map，存储了多个DataSource，会调用<code>determineCurrentLookupKey()</code>来Runtime决定使用哪个DataSource，如果没有指定的那个Key，那么就会使用DefaultDataSource<br>所以使用它就是需要</p>
<ul>
<li>Override <code>determineCurrentLookupKey()</code>方法，定义tenantId作为key<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultitenantDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractRoutingDataSource</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">determineCurrentLookupKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> TenantContext.getCurrentTenant();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>调用<code>setTargetDataSources</code>方法去把Map填进去</li>
<li>调用<code>setDefaultTargetDataSource</code> 方法把DefaultDataSource设置好，最好是将DefaultDataSource设置成tenant管理数据库，保存tenant相关信息，但是作为一个demo，本项目就比较简单，直接把它设为一个tenant数据库<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultitenantConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MultitenantDataSource <span class="title">multitenantDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;Object,Object&gt; resolvedDataSources = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="comment">//db1</span></span><br><span class="line">        DataSourceBuilder dataSourceBuilder = DataSourceBuilder.create()</span><br><span class="line">                .url(<span class="string">&quot;jdbc:mysql://localhost/test&quot;</span>)</span><br><span class="line">                .username(<span class="string">&quot;root&quot;</span>)</span><br><span class="line">                .password(<span class="string">&quot;******&quot;</span>);</span><br><span class="line">        resolvedDataSources.put(<span class="string">&quot;tenant1&quot;</span>,dataSourceBuilder.build());</span><br><span class="line">        resolvedDataSources.put(<span class="string">&quot;Default&quot;</span>,dataSourceBuilder.build());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//db2</span></span><br><span class="line">        DataSourceBuilder dataSourceBuilder2 = DataSourceBuilder.create()</span><br><span class="line">                .url(<span class="string">&quot;jdbc:mysql://localhost/test2&quot;</span>)</span><br><span class="line">                .username(<span class="string">&quot;root&quot;</span>)</span><br><span class="line">                .password(<span class="string">&quot;******&quot;</span>);</span><br><span class="line">        resolvedDataSources.put(<span class="string">&quot;tenant2&quot;</span>,dataSourceBuilder2.build());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        MultitenantDataSource dataSource = <span class="keyword">new</span> MultitenantDataSource();</span><br><span class="line">        dataSource.setDefaultTargetDataSource(resolvedDataSources.get(<span class="string">&quot;Default&quot;</span>));</span><br><span class="line">        dataSource.setTargetDataSources(resolvedDataSources);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        dataSource.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>在Controller里添加从header读取tenantId的逻辑<br><code>XXController.java</code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Member <span class="title">member</span><span class="params">(<span class="meta">@PathVariable(&quot;name&quot;)</span> String name, <span class="meta">@RequestHeader(&quot;X-TenantID&quot;)</span> String tenantName)</span></span>&#123;</span><br><span class="line">	TenantContext.setCurrentTenant(tenantName);</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="Runtime-添加DataSource"><a href="#Runtime-添加DataSource" class="headerlink" title="Runtime 添加DataSource"></a>Runtime 添加DataSource</h1><h2 id="效果-1"><a href="#效果-1" class="headerlink" title="效果"></a>效果</h2><ul>
<li>注册新的tenant，直接把jdbc url，username， password通过request parameter传入，返回success</li>
<li>通过header控制tenantId，访问新的tenant（DataSource）的数据<br><img src="https://img-blog.csdn.net/20180723152120781?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2ZhbmppbmdkYW4=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"><h2 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h2></li>
<li>写一个<code>MultitenantDataSourceRegister.java </code> (<code>implements ImportBeanDefinitionRegistrar</code>), 就要实现 <code> registerBeanDefinitions</code>方法 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata annotaion, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;registerBeanDefinitions&quot;</span>);</span><br><span class="line">    GenericBeanDefinition beanDefinition = <span class="keyword">new</span> GenericBeanDefinition();</span><br><span class="line">    beanDefinition.setBeanClass(MultitenantDataSource.class);</span><br><span class="line">    beanDefinition.setSynthetic(<span class="keyword">true</span>);</span><br><span class="line">    MutablePropertyValues mpv = beanDefinition.getPropertyValues();</span><br><span class="line"></span><br><span class="line">    mpv.addPropertyValue(<span class="string">&quot;defaultTargetDataSource&quot;</span>, getDefaultDataSources().get(<span class="string">&quot;Default&quot;</span>));</span><br><span class="line">    mpv.addPropertyValue(<span class="string">&quot;targetDataSources&quot;</span>,getDefaultDataSources());</span><br><span class="line">    registry.registerBeanDefinition(<span class="string">&quot;dataSource&quot;</span>, beanDefinition);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>在 <code>MultitenantConfiguration</code>上添加<code>@Import(MultitenantDataSourceRegister.class)</code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import(MultitenantDataSourceRegister.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultitenantConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MultitenantDataSource multitenantDataSource;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>在<code>MultitenantDataSource</code>里维护一个Map用来管理DataSources<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultitenantDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractRoutingDataSource</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">determineCurrentLookupKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> TenantContext.getCurrentTenant();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> ConcurrentHashMap&lt;String, DataSource&gt; backupTargetDataSources = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addDataSourceToTargetDataSource</span><span class="params">(String key ,DataSource ds)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.backupTargetDataSources.put(key, ds);</span><br><span class="line">        <span class="keyword">this</span>.setTargetDataSource(<span class="keyword">this</span>.backupTargetDataSources);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTargetDataSource</span><span class="params">(Map targetDataSource)</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.setTargetDataSources(targetDataSource);</span><br><span class="line">        <span class="keyword">this</span>.afterPropertiesSet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>在<code>XXController</code>里添加注册DataSource的API<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/api/tenant/register&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">tenantRegister</span><span class="params">(<span class="meta">@RequestParam</span> String username, <span class="meta">@RequestParam</span> String password, <span class="meta">@RequestParam</span> String url, <span class="meta">@RequestParam</span> String tenantName)</span> </span>&#123;</span><br><span class="line">	MultitenantDataSource multitenantDataSource = ctx.getBean(MultitenantDataSource.class);</span><br><span class="line">	DataSourceBuilder dataSourceBuilder = DataSourceBuilder.create()</span><br><span class="line">			.url(url)</span><br><span class="line">			.username(username)</span><br><span class="line">			.password(password);</span><br><span class="line">	multitenantDataSource.addDataSourceToTargetDataSource(tenantName, dataSourceBuilder.build());</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanjingdan012.github.io/2018/07/26/hexo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="FJD">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FJD">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/07/26/hexo/" class="post-title-link" itemprop="url">hexo</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-07-26 16:13:14" itemprop="dateCreated datePublished" datetime="2018-07-26T16:13:14+08:00">2018-07-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-19 17:52:32" itemprop="dateModified" datetime="2021-11-19T17:52:32+08:00">2021-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Markdown/" itemprop="url" rel="index"><span itemprop="name">Markdown</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Set-up"><a href="#Set-up" class="headerlink" title="Set up"></a>Set up</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo init</span><br><span class="line"><span class="built_in">cd</span> themes</span><br><span class="line">git <span class="built_in">clone</span> git@github.com:theme-next/hexo-theme-next.git</span><br></pre></td></tr></table></figure>

<h1 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h1><p><code>hexo d</code> not working<br>try this in <code>_config.yml</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repo: https://&#123;yourname&#125;:&#123;yourpassword&#125;@github.com/&#123;yourname&#125;/&#123;yourname&#125;.github.io.git</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure>

<h1 id="Md-sequence-and-flowchart"><a href="#Md-sequence-and-flowchart" class="headerlink" title="Md sequence and flowchart"></a>Md sequence and flowchart</h1><h2 id="sequence"><a href="#sequence" class="headerlink" title="sequence"></a><a target="_blank" rel="noopener" href="https://github.com/bubkoo/hexo-filter-sequence">sequence</a></h2><h3 id="code"><a href="#code" class="headerlink" title="code:"></a>code:</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Alice-&gt;Bob: Hello Bob, how are you?</span><br><span class="line">Note right of Bob: Bob thinks</span><br><span class="line">Bob--&gt;Alice: I am good thanks!</span><br></pre></td></tr></table></figure>

<h3 id="result"><a href="#result" class="headerlink" title="result:"></a>result:</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Alice-&gt;Bob: Hello Bob, how are you?</span><br><span class="line">Note right of Bob: Bob thinks</span><br><span class="line">Bob--&gt;Alice: I am good thanks!</span><br></pre></td></tr></table></figure>
<h2 id="flowchart"><a href="#flowchart" class="headerlink" title="flowchart"></a><a target="_blank" rel="noopener" href="https://github.com/bubkoo/hexo-filter-flowchart">flowchart</a></h2><h3 id="code-1"><a href="#code-1" class="headerlink" title="code:"></a>code:</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">st=&gt;start: Start|past:&gt;http://www.google.com[blank]</span><br><span class="line">e=&gt;end: End:&gt;http://www.google.com</span><br><span class="line">op1=&gt;operation: My Operation|past</span><br><span class="line">op2=&gt;operation: Stuff|current</span><br><span class="line">sub1=&gt;subroutine: My Subroutine|invalid</span><br><span class="line">cond=&gt;condition: Yes</span><br><span class="line">or No?|approved:&gt;http://www.google.com</span><br><span class="line">c2=&gt;condition: Good idea|rejected</span><br><span class="line">io=&gt;inputoutput: catch something...|request</span><br><span class="line"></span><br><span class="line">st-&gt;op1(right)-&gt;cond</span><br><span class="line">cond(yes, right)-&gt;c2</span><br><span class="line">cond(no)-&gt;sub1(left)-&gt;op1</span><br><span class="line">c2(yes)-&gt;io-&gt;e</span><br><span class="line">c2(no)-&gt;op2-&gt;e</span><br></pre></td></tr></table></figure>


<h3 id="result-1"><a href="#result-1" class="headerlink" title="result:"></a>result:</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">st=&gt;start: Start|past:&gt;http://www.google.com[blank]</span><br><span class="line">e=&gt;end: End:&gt;http://www.google.com</span><br><span class="line">op1=&gt;operation: My Operation|past</span><br><span class="line">op2=&gt;operation: Stuff|current</span><br><span class="line">sub1=&gt;subroutine: My Subroutine|invalid</span><br><span class="line">cond=&gt;condition: Yes</span><br><span class="line">or No?|approved:&gt;http://www.google.com</span><br><span class="line">c2=&gt;condition: Good idea|rejected</span><br><span class="line">io=&gt;inputoutput: catch something...|request</span><br><span class="line"></span><br><span class="line">st-&gt;op1(right)-&gt;cond</span><br><span class="line">cond(yes, right)-&gt;c2</span><br><span class="line">cond(no)-&gt;sub1(left)-&gt;op1</span><br><span class="line">c2(yes)-&gt;io-&gt;e</span><br><span class="line">c2(no)-&gt;op2-&gt;e</span><br></pre></td></tr></table></figure>

<h1 id="让-Hexo-搭建的博客支持-LaTeX"><a href="#让-Hexo-搭建的博客支持-LaTeX" class="headerlink" title="让 Hexo 搭建的博客支持 LaTeX"></a><a target="_blank" rel="noopener" href="https://cps.ninja/2019/03/16/hexo-with-latex/">让 Hexo 搭建的博客支持 LaTeX</a></h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fanjingdan012.github.io/2018/04/11/Memory-Hierachy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="FJD">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FJD">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/04/11/Memory-Hierachy/" class="post-title-link" itemprop="url">Memory Hierachy</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-04-11 09:39:10" itemprop="dateCreated datePublished" datetime="2018-04-11T09:39:10+08:00">2018-04-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-19 17:52:32" itemprop="dateModified" datetime="2021-11-19T17:52:32+08:00">2021-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Computer-Science/" itemprop="url" rel="index"><span itemprop="name">Computer Science</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="https://fanjingdan012.github.io/2018/04/11/Memory-Hierachy/memory.png" alt="memory.png"></p>
<h1 id="存储技术-书6"><a href="#存储技术-书6" class="headerlink" title="存储技术(书6)"></a>存储技术(书6)</h1><ul>
<li><p>RAM(Random Access Memory)</p>
<ul>
<li><p>SRAM(Static RAM)</p>
<ul>
<li>快，10倍速度DRAM</li>
<li>贵，100倍价格DRAM</li>
<li>做Cache</li>
</ul>
</li>
<li><p>DRAM(Dynamic RAM)</p>
<ul>
<li>主存</li>
<li>frame buffer</li>
<li>增强版DRAM<ul>
<li>SDRAM(Synchronous DRAM)</li>
<li>Double Data-Rate SDRAM(DDR SDRAM)<ul>
<li>DDR(2bit prefetch buffer) </li>
<li>DDR2(4bit …) </li>
<li>DDR3(8bit …)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>访问主存</p>
<ul>
<li><p>读<br><code>movq A, %rax</code></p>
<ol>
<li>CPU通过总线接口发起读事务，把地址A放到系统总线上</li>
<li>A走过I/O桥接器，走到存储器总线</li>
<li>主存感觉并获取A，读取A的内容，写到存储器总线</li>
<li>I/O桥接器翻译转换成系统总线信号</li>
<li>CPU感觉并获取数据，copy给%rax</li>
</ol>
</li>
<li><p>写<br><code>movq %rax A</code></p>
<ol>
<li>CPU把A放在总线上</li>
<li>主存从总线获取A，并等待数据到达</li>
<li>CPU把%rax的数据copy到总线</li>
<li>主存拿到数据存入A</li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
<li><p>断电可以存储的</p>
<ul>
<li>ROM(Read-only memory)</li>
<li>PROM(Programmable ROM) 可以烧制一次程序</li>
<li>EPROM(Eraseable PROM) 可以重复烧制</li>
<li>EEPROM(Electrically Eraseable PROM) 比如Flash memory</li>
<li>磁盘<br>见图</li>
</ul>
</li>
</ul>
<h1 id="Locality局部性"><a href="#Locality局部性" class="headerlink" title="Locality局部性"></a>Locality局部性</h1><ul>
<li>时间局部性：一个变量在集中的时间里一直访问就会一直cache hit</li>
<li>空间局部性：相关数据放在一起（一个 block）就会一起进缓存</li>
</ul>
<h1 id="Hierarchy"><a href="#Hierarchy" class="headerlink" title="Hierarchy"></a>Hierarchy</h1><p><img src="https://fanjingdan012.github.io/2018/04/11/Memory-Hierachy/memory-hierarchy.png" alt="memory-hierarchy.png"></p>
<h2 id="Disk"><a href="#Disk" class="headerlink" title="Disk"></a>Disk</h2><p>见上图</p>
<h2 id="Cache"><a href="#Cache" class="headerlink" title="Cache"></a>Cache</h2><p>见上图</p>
<ul>
<li>上层是下层的子集</li>
<li>数据以块传输</li>
<li>下层更大，慢，便宜</li>
<li>读：hit的话直接返回，miss的话replace<ul>
<li>cache hit</li>
<li>cache miss<ul>
<li>cold miss、compulsory miss（强制性不命中）</li>
<li>conflict miss，e.g.用了下一层的块i放在上一层的块（i mod 4）中的放置策略，然后访问块0,块4,块0,块4。。。就会一直miss </li>
<li>capacity miss：缓存太小了</li>
</ul>
</li>
<li>replacing、evicting victim block，只要发生了不命中就会执行某替换策略<ul>
<li>策略<ul>
<li>换掉谁？e.g.Least Recent Used（LRU）, Frequently(LFU)</li>
<li>新的放哪? e.g. 随机， 下一层的块i放在上一层的块（i mod 4）中</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>写：<ul>
<li>write hit<ul>
<li>write-through：直接更新主存</li>
<li>write-back（真的用的）：推迟更新主存,减少bus的使用，需要额外维护一个dirty bit，标记是不是改过</li>
</ul>
</li>
<li>write miss<ul>
<li>write-allocate（真的用的）:先加载到cache，再更新+write-back</li>
<li>not-write-allocate：直接更新主存+write-through</li>
</ul>
</li>
</ul>
</li>
<li>保存啥的<ul>
<li>i-cache：存指令</li>
<li>d-cache：存数据</li>
<li>unified cache：两个都存，e.g. L2</li>
</ul>
</li>
<li>KPI<ul>
<li>miss rate = 1- hit rate</li>
<li>hit time(命中花多久)、 miss penalty（不命中花多久）</li>
</ul>
</li>
</ul>
<h1 id="Virtual-Memory-书10-1-10-8"><a href="#Virtual-Memory-书10-1-10-8" class="headerlink" title="Virtual Memory(书10.1-10.8)"></a>Virtual Memory(书10.1-10.8)</h1><h2 id="Why-Virtual-Memory"><a href="#Why-Virtual-Memory" class="headerlink" title="Why Virtual Memory"></a>Why Virtual Memory</h2><ul>
<li>4k/4m/…一个page，搞cache</li>
<li>memory管理，每个进程有自己的<b>地址空间</b>, 2G的物理内存虚拟出4G没问题</li>
<li>memory保护，可以做权限管理，在PTE上加权限位，MMU负责检查<h2 id="How"><a href="#How" class="headerlink" title="How"></a>How</h2>见上图<h2 id="Memory-mapping"><a href="#Memory-mapping" class="headerlink" title="Memory mapping"></a>Memory mapping</h2></li>
</ul>
<h1 id="Heap-amp-Malloc-书10-9"><a href="#Heap-amp-Malloc-书10-9" class="headerlink" title="Heap &amp; Malloc(书10.9)"></a>Heap &amp; Malloc(书10.9)</h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">FJD</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">49</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">FJD</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
